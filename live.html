
<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>FayWooooo Liveï½œç›´æ’­é€šè¡Œè­‰ä¸­å¿ƒï½œå³æ™‚ç›´æ’­ã€ä»»å‹™ã€XP çå‹µèˆ‡ Fay å¹£</title>

<meta name="description" content="FayWooooo Live æä¾›å³æ™‚ç›´æ’­ã€é™æ™‚ä»»å‹™ã€Live Pass XP å‡ç´šèˆ‡ Fay å¹£çå‹µã€‚ç™»å…¥å³å¯åœ¨è§€çœ‹ç›´æ’­é€”ä¸­è‡ªå‹•ç²å¾— XPï¼Œæ¯ 15 åˆ†é˜é ˜å–çå‹µä¸¦å…Œæ› Fay å¹£ã€‚">


<!-- Google å­—å‹ -->
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;600;700&display=swap" rel="stylesheet">

<!-- Font Awesome Icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<style>
/* ================================================
   ğŸŒˆ FayWooooo Live Page å…¨ç«™çµ±ä¸€é¢¨æ ¼
================================================ */
* { box-sizing: border-box; }
body {
  font-family: "Noto Sans TC", sans-serif;
  margin:0; padding:0; color:white; text-align:center;
  background: rgb(10,10,10); min-height:100vh;
  overflow-x:hidden; padding-top:80px;
}
::selection { background: rgba(4,255,0,0.236); }

main { background: radial-gradient(ellipse at bottom,#0a1a2f 0%,#000814 100%); padding:50px 20px; }

.title {
  font-size:3rem; margin-bottom: 40px;
  color:#34ff85c6;
  text-shadow:0 0 10px #34ff85c6,0 0 20px #34ff85c0,0 0 40px #34ff85b4;
  animation: glow 2s ease-in-out infinite alternate;
}
@keyframes glow { from{text-shadow:0 0 10px #34ff85c6;} to{text-shadow:0 0 30px #34ff85ff;} }

body::before {
  content:""; position:fixed; inset:0;
  background: radial-gradient(circle at 30% 30%, rgba(255,215,0,0.05), transparent 60%),
              radial-gradient(circle at 70% 80%, rgba(0,140,255,0.05), transparent 60%);
  z-index:-1;
}

/* é ‚éƒ¨å°è¦½åˆ— */
.topbar {
  position: fixed; top:0; left:0; right:0;
  height:65px; background:rgba(255,255,255,0.95);
  border-bottom:1px solid rgba(255,255,255,0.2);
  display:flex; justify-content:space-between; align-items:center;
  padding:0 25px; z-index:100; backdrop-filter: blur(10px);
}
.logo { font-size:1.4rem; font-weight:700; color:#000; }
.navbar { display:flex; gap:16px; }
.navbar a { text-decoration:none; color:#000; font-weight:600; padding:8px 14px; border-radius:10px; transition:0.2s; }
.navbar a:hover, .navbar a.active { background: rgb(255,250,203); box-shadow:0 0 10px rgba(255,215,0,0.5); color:#000814; }

/* ä½¿ç”¨è€…è³‡è¨Šå€ */
#userArea { display:flex; align-items:center; gap:12px; }
#avatarBtn { width:40px; height:40px; border-radius:50%; border:2px solid #ccc; object-fit: cover; }
#coinDisplay { color:#000; font-weight:bold; font-size:1rem; display:flex; align-items:center; gap:5px; }

/* Grid Layout */
.grid-container {
  display: grid; grid-template-columns: 2fr 1fr; gap: 25px;
  max-width: 1200px; margin: 0 auto;
}
@media(max-width: 900px) { .grid-container { grid-template-columns: 1fr; } }

/* é€šç”¨å¡ç‰‡é¢¨æ ¼ */
.glass-card {
  background: rgba(255,255,255,0.08);
  border-radius:20px;
  border:1px solid rgba(255,255,255,0.15);
  backdrop-filter: blur(20px);
  padding:25px;
  box-shadow:0 0 20px rgba(0,0,0,0.3);
  text-align: left;
}

/* ç›´æ’­å€ */
.live-frame iframe { width:100%; aspect-ratio: 16/9; border-radius:12px; border:none; box-shadow: 0 4px 15px rgba(0,0,0,0.5); }
.live-status {
  display: inline-block; background: #ff0000; color: white; padding: 4px 12px; 
  border-radius: 4px; font-size: 0.8rem; font-weight: bold; margin-bottom: 15px;
  box-shadow: 0 0 10px rgba(255,0,0,0.5); animation: pulse 2s infinite;
}
@keyframes pulse { 0%{opacity:1;} 50%{opacity:0.7;} 100%{opacity:1;} }

/* ğŸŒŸ Live Pass å¡ç‰‡ */
.pass-card { position:relative; overflow:hidden; background: linear-gradient(135deg, rgba(255,255,255,0.1), rgba(255,255,255,0.05)); }
.pass-header { display:flex; justify-content:space-between; align-items:flex-end; margin-bottom:15px; }
.pass-title { font-size:1.5rem; font-weight:800; font-style:italic; color:white; margin:0; }
.pass-season { font-size:0.8rem; color:#aaa; letter-spacing:2px; }
.next-reward { text-align:right; }
.reward-amount { color: gold; font-size:1.4rem; font-weight:bold; text-shadow:0 0 10px rgba(255,215,0,0.5); }

/* é€²åº¦æ¢ */
.progress-label { display:flex; justify-content:space-between; font-size:0.85rem; color:#34ff85; margin-bottom:5px; font-weight:bold; }
.progress-track { width:100%; height:12px; background:rgba(0,0,0,0.5); border-radius:6px; border:1px solid rgba(255,255,255,0.2); overflow:hidden; }
.progress-fill { height:100%; background: linear-gradient(90deg, #34ff85, #00d4ff); width:0%; transition: width 0.5s ease; box-shadow: 0 0 10px #34ff85; }

.pass-info { font-size:0.8rem; color:#888; margin-top:15px; border-top:1px solid rgba(255,255,255,0.1); padding-top:10px; }
.pass-info li { margin-bottom:4px; list-style: none; }
.pass-info ul { padding-left:0; margin:0; }

/* ä»»å‹™åˆ—è¡¨ */
.mission-item {
  background: rgba(0,0,0,0.2); border:1px solid rgba(255,255,255,0.1);
  border-radius:12px; padding:12px; margin-bottom:10px; transition:0.3s;
}
.mission-item.completed { border-color:#34ff85; background:rgba(52, 255, 133, 0.05); }
.mission-header { display:flex; justify-content:space-between; margin-bottom:5px; }
.mission-title { font-weight:bold; font-size:0.95rem; }
.mission-xp { font-size:0.8rem; background:rgba(255,255,255,0.15); padding:2px 6px; border-radius:4px; color:#ffd700; }
.mission-desc { font-size:0.8rem; color:#aaa; margin-bottom:8px; }
.status-text { font-size:0.8rem; font-weight:bold; color:#34ff85; display:flex; align-items:center; gap:5px; }

/* Logs */
#logArea {
  margin-top: 15px; font-size: 0.8rem; color: #ccc; max-height: 100px; overflow-y: auto;
}
.log-entry { margin-bottom: 4px; animation: fadeIn 0.5s; }
.log-entry span { color: #34ff85; margin-right:5px; }
@keyframes fadeIn { from{opacity:0; transform:translateY(5px);} to{opacity:1; transform:translateY(0);} }

/* Scrollbar */
::-webkit-scrollbar { width:6px; }
::-webkit-scrollbar-thumb { background:rgba(255,255,255,0.3); border-radius:3px; }.mobile-nav {
  display: none;
}
/* ============================================
   ğŸ“± Mobile UI â€” å°æ–¼ 600px é€²å…¥æ‰‹æ©Ÿæ¨¡å¼
============================================ */
@media(max-width: 600px) {

  body {
    padding-top: 70px;
    font-size: 14px;
  }

  /* Topbar æ›´åƒ APP çš„ä¸Šæ–¹å·¥å…·åˆ— */
  .topbar {
    height: 55px;
    padding: 0 12px;
  }

  .logo {
    font-size: 1rem;
  }

  /* å°è¦½åˆ—æ”¹ç‚ºã€Œåº•éƒ¨å›ºå®šçš„ 4 å¤§æŒ‰éˆ•ã€ */
  .navbar {
    display: none; /* éš±è—åŸæœ¬çš„ */
  }

  /* æ–°çš„åº•éƒ¨å°èˆªåˆ— */
  body::after {
    content:"";
    height:60px;
    visibility:hidden; /* é¨°å‡ºç©ºé–“ */
    display:block;
  }

  .mobile-nav {
    position: fixed;
    bottom: 0; left: 0; right: 0;
    height: 60px;
    background: rgba(255,255,255,0.95);
    backdrop-filter: blur(10px);
    display: flex;
    justify-content: space-around;
    align-items: center;
    border-top: 1px solid rgba(255,255,255,0.3);
    z-index: 999;
  }
  .mobile-nav a {
    text-decoration: none;
    color: #000;
    font-size: 0.75rem;
    display: flex;
    flex-direction: column;
    align-items: center;
  }
  .mobile-nav i {
    font-size: 1.2rem;
    margin-bottom: 2px;
  }

  /* Layout å®Œæ•´æ‰‹æ©ŸåŒ– */
  .grid-container {
    grid-template-columns: 1fr;
    gap: 15px;
  }

  /* ç›´æ’­ iframe ç¸®å°é‚Šè· */
  .live-frame iframe {
    border-radius: 10px;
  }

  .glass-card {
    padding: 18px;
  }

  /* Live Pass å¡ç‰‡ç¸®å° */
  .pass-title {
    font-size: 1.2rem;
  }
  .reward-amount {
    font-size: 1.1rem;
  }

  /* ä»»å‹™é …ç›®æ›´ç·Šæ¹Š */
  .mission-item {
    padding: 10px;
  }
  .mission-title {
    font-size: 0.9rem;
  }
  .mission-desc {
    font-size: 0.75rem;
  }
}

</style>
</head>

<body>
  <div class="mobile-nav">
    <a href="home"><i class="fas fa-home"></i>é¦–é </a>
    <a href="shop"><i class="fas fa-store"></i>å…Œæ›</a>
    <a href="live" class="active"><i class="fas fa-video"></i>ç›´æ’­</a>
  </div>
  
<!-- å°è¦½åˆ— -->
<div class="topbar">
  <div class="logo">FayWooooo ç›´æ’­é€šè¡Œè­‰ä¸­å¿ƒ</div>
  <div class="navbar">
    <a href="index.html">é¦–é </a>
    <a href="missions.html">ä»»å‹™</a>
    <a href="shop.html">å…Œæ›</a>
    <a href="live.html" class="active">ç›´æ’­</a>
  </div>
  <div id="userArea">
    <span id="coinDisplay"><i class="fas fa-coins"></i> <span id="coinValue">...</span></span>
    <img id="avatarBtn" src="https://api.dicebear.com/7.x/avataaars/svg?seed=Guest" class="avatar">
  </div>
</div>

<main>
 
  <div class="grid-container">
    
    <!-- å·¦å´ï¼šç›´æ’­ -->
    <div style="display:flex; flex-direction:column; gap:20px;">
      <div class="glass-card">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
          <h3 style="margin:0; color:#34ff85; display:flex; align-items:center; gap:10px;">
             <span class="live-status">LIVE</span> æ­£åœ¨ç›´æ’­
             <!-- éš±è—çš„ç®¡ç†å“¡ç·¨è¼¯æŒ‰éˆ• -->
             <i id="adminEditBtn" class="fas fa-edit" style="display:none; cursor:pointer; color:#ffd700; font-size:1.2rem; margin-left:8px;" title="ä¿®æ”¹ç›´æ’­é€£çµ (ç®¡ç†å“¡)"></i>
          </h3>
          <span id="videoTitle" style="color:#aaa; font-size:0.9rem;">è¼‰å…¥ä¸­...</span>
        </div>
        
        <div class="live-frame">
          <iframe id="ytLive" src="" allowfullscreen></iframe>
        </div>
      </div>
      
      <!-- ç³»çµ±ç´€éŒ„ -->
      <div class="glass-card" style="min-height:150px;">
        <h4 style="margin:0 0 10px 0; border-bottom:1px solid rgba(255,255,255,0.1); padding-bottom:5px; color:#aaa;">
          <i class="fas fa-terminal"></i> çå‹µç´€éŒ„
        </h4>
        <div id="logArea">
          <div class="log-entry" style="color:#666;">ç­‰å¾…æ´»å‹•ä¸­...</div>
        </div>
      </div>
    </div>

    <!-- å³å´ï¼šLive Pass èˆ‡ä»»å‹™ -->
    <div style="display:flex; flex-direction:column; gap:20px;">
      
      <!-- Live Pass Card -->
      <div class="glass-card pass-card">
        <div class="pass-header">
          <div>
            <div class="pass-title">LIVE PASS</div>
            <div class="pass-season">SEASON 1</div>
          </div>
          <div class="next-reward">
            <div style="font-size:0.8rem; color:#ddd;">Next Drop</div>
            <div class="reward-amount">+50 <i class="fas fa-coins"></i></div>
          </div>
        </div>

        <!-- Progress -->
        <div class="progress-label">
          <span id="xpDisplay">0 XP</span>
          <span>100 XP</span>
        </div>
        <div class="progress-track">
          <div id="xpBar" class="progress-fill"></div>
        </div>
        <p style="font-size:0.8rem; text-align:center; color:#888; margin-top:8px;">
          ä¸‹ä¸€æ¬¡ XP ç™¼æ”¾: <span id="nextDropMin" style="color:white; font-weight:bold;">15</span> åˆ†é˜å¾Œ
        </p>

        <div class="pass-info">
          <ul>
            <li>â€¢ æ¯ 15 åˆ†é˜ç²å¾— 50 XP</li>
            <li>â€¢ æ¯ 100 XP è‡ªå‹•å…Œæ› 50 Fay å¹£</li>
            <li>â€¢ å®Œæˆä¸‹æ–¹ä»»å‹™åŠ é€Ÿå‡ç´š</li>
          </ul>
        </div>
      </div>

      <!-- ä»»å‹™åˆ—è¡¨ -->
      <div class="glass-card">
        <h3 style="margin-top:0; margin-bottom:15px; font-size:1.1rem;">
          <i class="fas fa-tasks"></i> é™æ™‚ä»»å‹™
        </h3>
        <div id="missionList">
          <!-- ä»»å‹™é …ç›®ç”± JS æ¸²æŸ“ -->
          <div style="text-align:center; color:#aaa;">è¼‰å…¥ä»»å‹™ä¸­...</div>
        </div>
      </div>

    </div>
  </div>
</main>

<footer>Â© 2025 FayWooooo å®˜æ–¹ç¶²ç«™</footer>

<script type="module">
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

// âš ï¸ æ›¿æ›ç‚ºä½ çš„ Supabase URL å’Œ Anon Key
const supabaseUrl = "https://wcqutexugvrgnyusnkpv.supabase.co";
const supabaseKey = "YOUR_ANON_KEY"; 
const supabase = createClient(supabaseUrl, supabaseKey);

const FUNCTION_URL = `${supabaseUrl}/functions/v1/LivePage`;

let pingInterval;
const STATE = {
  sessionMinutes: 0,
  xp: 0
};

// =======================
// æ ¸å¿ƒ API å‘¼å«
// =======================
async function callBackend(action, payload = {}) {
  const { data: { session } } = await supabase.auth.getSession();
  if (!session) return { error: "å°šæœªç™»å…¥" };

  try {
    const res = await fetch(FUNCTION_URL, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": `Bearer ${session.access_token}`
      },
      body: JSON.stringify({ action, ...payload })
    });
    return await res.json();
  } catch (e) {
    console.error("API Error:", e);
    return { error: e.message };
  }
}

// =======================
// UI æ›´æ–°é‚è¼¯
// =======================
function updateUI(data) {
  if (!data) return;

  // 1. æ›´æ–° Fay å¹£
  if (data.fayCoins !== undefined) {
    document.getElementById("coinValue").textContent = data.fayCoins;
  }

  // 2. æ›´æ–° Live Pass XP æ¢
  const currentXP = data.currentXP || 0;
  STATE.xp = currentXP;
  
  const xpPercent = Math.min(100, (currentXP / 100) * 100);
  document.getElementById("xpBar").style.width = `${xpPercent}%`;
  document.getElementById("xpDisplay").textContent = `${currentXP} XP`;

  // 3. æ›´æ–°å€’æ•¸æ™‚é–“
  if (data.sessionMinutes !== undefined) {
    STATE.sessionMinutes = data.sessionMinutes;
    const minsUntilReward = 15 - (data.sessionMinutes % 15);
    document.getElementById("nextDropMin").textContent = minsUntilReward === 0 ? 15 : minsUntilReward;
  }

  // 4. æ›´æ–°ä»»å‹™åˆ—è¡¨
  if (data.missions) {
    renderMissions(data.missions);
  }

  // 5. é¡¯ç¤º Logs
  if (data.logs && data.logs.length > 0) {
    const logArea = document.getElementById("logArea");
    if (logArea.innerText.includes("ç­‰å¾…")) logArea.innerHTML = "";
    
    data.logs.forEach(log => {
      const div = document.createElement("div");
      div.className = "log-entry";
      div.innerHTML = `<span>âœ</span> ${log}`;
      logArea.prepend(div);
    });
  }
  
  // 6. ç›´æ’­å½±ç‰‡èˆ‡æ¨™é¡Œ (å¾å¾Œç«¯ DB è®€å–)
  if(data.youtubeId) {
    const frame = document.getElementById("ytLive");
    // åªæœ‰ç•¶ ID ä¸åŒæ™‚æ‰æ›´æ–° srcï¼Œé¿å…ä¸€ç›´é‡æ–°æ•´ç†å½±ç‰‡
    if(!frame.src.includes(data.youtubeId)) {
        frame.src = `https://www.youtube.com/embed/${data.youtubeId}?autoplay=1&mute=1`;
    }
  }
  if(data.videoTitle) {
    document.getElementById("videoTitle").textContent = data.videoTitle;
  }

  // 7. ç®¡ç†å“¡åŠŸèƒ½
  if (data.isAdmin) {
    const editBtn = document.getElementById("adminEditBtn");
    editBtn.style.display = "inline-block";
    
    // ç¶å®šç·¨è¼¯é»æ“Šäº‹ä»¶
    editBtn.onclick = async () => {
        const newId = prompt("è«‹è¼¸å…¥æ–°çš„ YouTube å½±ç‰‡ ID (ä¾‹å¦‚: n28znBIzLCk):", data.youtubeId);
        if (!newId) return;
        const newTitle = prompt("è«‹è¼¸å…¥æ–°çš„ç›´æ’­æ¨™é¡Œ:", data.videoTitle);
        
        const result = await callBackend("updateStream", { youtubeId: newId, title: newTitle || "FayWooooo Live" });
        if (result.success) {
            alert("æ›´æ–°æˆåŠŸï¼é é¢å°‡é‡æ–°æ•´ç†ã€‚");
            window.location.reload();
        } else {
            alert("æ›´æ–°å¤±æ•—: " + (result.error || "æœªçŸ¥éŒ¯èª¤"));
        }
    };
  }
}

function renderMissions(missions) {
  const container = document.getElementById("missionList");
  container.innerHTML = "";

  missions.forEach(m => {
    const percent = Math.min(100, (m.current / m.target) * 100);
    const isDone = m.completed;

    const html = `
      <div class="mission-item ${isDone ? 'completed' : ''}">
        <div class="mission-header">
          <span class="mission-title">${m.title}</span>
          <span class="mission-xp">+${m.rewardXP} XP</span>
        </div>
        <div class="mission-desc">${m.description}</div>
        
        ${isDone ? `
          <div class="status-text"><i class="fas fa-check-circle"></i> å·²å®Œæˆ</div>
        ` : `
          <div class="progress-track" style="height:6px; background:rgba(255,255,255,0.1);">
            <div class="progress-fill" style="width:${percent}%; background:#00d4ff;"></div>
          </div>
          <div style="text-align:right; font-size:0.7rem; color:#888; margin-top:2px;">
            ${m.current} / ${m.target} min
          </div>
        `}
      </div>
    `;
    container.innerHTML += html;
  });
}

// =======================
// åˆå§‹åŒ–èˆ‡è¨ˆæ™‚å™¨
// =======================
async function init() {
  const { data: { session } } = await supabase.auth.getSession();
  if (!session) {
    alert("è«‹å…ˆç™»å…¥ä»¥ç´¯ç©çå‹µ");
    window.location.href = "index.html"; 
    return;
  }

  // é¡¯ç¤ºå€‹è³‡
  document.getElementById("avatarBtn").src = session.user.user_metadata.avatar_url || "https://api.dicebear.com/7.x/avataaars/svg?seed=User";

  // åˆå§‹ç‹€æ…‹è®€å–
  const initData = await callBackend("init");
  if(!initData.error) updateUI(initData);

  // å•Ÿå‹•å¿ƒè·³ (æ¯ 60 ç§’ Ping ä¸€æ¬¡)
  pingInterval = setInterval(async () => {
    const pong = await callBackend("ping");
    if(!pong.error) updateUI(pong);
  }, 60000); 
}

document.addEventListener("DOMContentLoaded", init);
</script>

</body>
</html>
