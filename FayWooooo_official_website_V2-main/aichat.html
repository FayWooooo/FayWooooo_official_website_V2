<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Fay AI</title>
  <link rel="stylesheet" href="css/style.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/js/all.min.js"></script>
  <style>
    main {
      background: radial-gradient(ellipse at bottom, #0a1a2f 0%, #000814 100%);
      height: calc(100vh - 65px);
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }

    .chat-box {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      scroll-behavior: smooth;
    }

    .bubble {
      max-width: 75%;
      padding: 10px 14px;
      border-radius: 16px;
      font-size: 15px;
      line-height: 1.5;
      word-break: break-word;
      display: inline-block;
      animation: fadeIn 0.3s ease;
      white-space: pre-wrap; /* âœ… ä¿ç•™æ›è¡Œ */
      text-align: left;
    }

    .from-user {
      align-self: flex-end;
      background: linear-gradient(135deg, #3affb1, #00b36b);
      color: #000;
      border-bottom-right-radius: 0;
      box-shadow: 0 0 10px rgba(52, 255, 133, 0.4);
      text-align: right;
    }

    .from-bot {
      align-self: flex-start;
      background: rgba(255, 255, 255, 0.1);
      color: #fff;
      border-bottom-left-radius: 0;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .typing {
      align-self: flex-start;
      background: rgba(255, 255, 255, 0.08);
      color: #fff;
      padding: 10px 16px;
      border-radius: 16px;
      border-bottom-left-radius: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 3px;
      width: 60px;
    }

    .dot {
      width: 8px;
      height: 8px;
      background: white;
      border-radius: 50%;
      animation: blink 1.2s infinite ease-in-out;
    }

    .dot:nth-child(2) { animation-delay: 0.2s; }
    .dot:nth-child(3) { animation-delay: 0.4s; }

    @keyframes blink {
      0%, 80%, 100% { opacity: 0.2; transform: scale(0.8); }
      40% { opacity: 1; transform: scale(1); }
    }

    .chat-input {
      display: flex;
      align-items: center;
      padding: 10px;
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(10px);
      border-top: 1px solid rgba(255, 255, 255, 0.1);
    }

    .chat-input input {
      flex: 1;
      padding: 10px;
      border: none;
      border-radius: 10px;
      background: rgba(255,255,255,0.1);
      color: white;
      outline: none;
      transition: opacity 0.3s;
    }

    .chat-input button {
      margin-left: 10px;
      padding: 10px 14px;
      border-radius: 10px;
      border: none;
      background: #34ff85c6;
      color: #000;
      font-weight: bold;
      cursor: pointer;
      transition: 0.2s;
    }

    .chat-input button:hover {
      background: #56ffa0;
      transform: scale(1.05);
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(8px); }
      to { opacity: 1; transform: translateY(0); }
    }/* ============================================
   ğŸ“± Mobile UI â€” å°æ–¼ 600px é€²å…¥æ‰‹æ©Ÿæ¨¡å¼
============================================ */
@media(max-width: 600px) {

  body {
    padding-top: 70px;
    font-size: 14px;
  }

  /* Topbar æ›´åƒ APP çš„ä¸Šæ–¹å·¥å…·åˆ— */
  .topbar {
    height: 55px;
    padding: 0 12px;
  }

  .logo {
    font-size: 1rem;
  }

  /* å°è¦½åˆ—æ”¹ç‚ºã€Œåº•éƒ¨å›ºå®šçš„ 4 å¤§æŒ‰éˆ•ã€ */
  .navbar {
    display: none; /* éš±è—åŸæœ¬çš„ */
  }

  /* æ–°çš„åº•éƒ¨å°èˆªåˆ— */
  body::after {
    content:"";
    height:60px;
    visibility:hidden; /* é¨°å‡ºç©ºé–“ */
    display:block;
  }

  .mobile-nav {
    position: fixed;
    bottom: 0; left: 0; right: 0;
    height: 60px;
    background: rgba(255,255,255,0.95);
    backdrop-filter: blur(10px);
    display: flex;
    justify-content: space-around;
    align-items: center;
    border-top: 1px solid rgba(255,255,255,0.3);
    z-index: 999;
  }
  .mobile-nav a {
    text-decoration: none;
    color: #000;
    font-size: 0.75rem;
    display: flex;
    flex-direction: column;
    align-items: center;
  }
  .mobile-nav i {
    font-size: 1.2rem;
    margin-bottom: 2px;
  }

  /* Layout å®Œæ•´æ‰‹æ©ŸåŒ– */
  .grid-container {
    grid-template-columns: 1fr;
    gap: 15px;
  }

  /* ç›´æ’­ iframe ç¸®å°é‚Šè· */
  .live-frame iframe {
    border-radius: 10px;
  }

  .glass-card {
    padding: 18px;
  }

  /* Live Pass å¡ç‰‡ç¸®å° */
  .pass-title {
    font-size: 1.2rem;
  }
  .reward-amount {
    font-size: 1.1rem;
  }

  /* ä»»å‹™é …ç›®æ›´ç·Šæ¹Š */
  .mission-item {
    padding: 10px;
  }
  .mission-title {
    font-size: 0.9rem;
  }
  .mission-desc {
    font-size: 0.75rem;
  }
}

  </style>
</head>
<body>
  <header class="topbar">
    <div class="logo"><i class="fa-solid fa-comments"></i> Fay AI</div>
    <nav class="navbar">
      <a href="index.html"><i class="fa-solid fa-house"></i> é¦–é </a>
    </nav>
  </header>
  <div class="mobile-nav">
    <a href="home"><i class="fas fa-home"></i>é¦–é </a>
    <a href="shop"><i class="fas fa-store"></i>å…Œæ›</a>
    <a href="live" class="active"><i class="fas fa-video"></i>ç›´æ’­</a>
  </div>
  <main>
    <div class="chat-box" id="chatBox">
      <div class="bubble from-bot">å—¨å—¨ï½æˆ‘æ˜¯ <b>Fay AI</b> ğŸ’š<br>æƒ³å•äº›ä»€éº¼å•é¡Œï¼Ÿ</div>
    </div>

    <div class="chat-input">
      <input type="text" id="userInput" placeholder="è¼¸å…¥è¨Šæ¯..." />
      <button id="sendBtn"><i class="fa-solid fa-paper-plane"></i></button>
    </div>
  </main>

  <script type="module">
    import { supabase } from "./js/supabase-config.js";

    const chatBox = document.getElementById("chatBox");
    const userInput = document.getElementById("userInput");
    const sendBtn = document.getElementById("sendBtn");
    const API_URL = "https://wcqutexugvrgnyusnkpv.supabase.co/functions/v1/fayai-smart";

    let isTyping = false; // âœ… é˜²æ­¢é‡è¤‡è¼¸å…¥

    function addBubble(role, text) {
      const div = document.createElement("div");
      div.className = "bubble " + (role === "user" ? "from-user" : "from-bot");
      div.innerHTML = text;
      chatBox.appendChild(div);
      chatBox.scrollTop = chatBox.scrollHeight;
      return div;
    }

    function addTyping() {
      const typingDiv = document.createElement("div");
      typingDiv.className = "typing";
      typingDiv.id = "typingIndicator";
      typingDiv.innerHTML = '<div class="dot"></div><div class="dot"></div><div class="dot"></div>';
      chatBox.appendChild(typingDiv);
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    function removeTyping() {
      const typingDiv = document.getElementById("typingIndicator");
      if (typingDiv) typingDiv.remove();
    }

    // âœ¨ æ‰“å­—å‹•ç•« + è‡ªå‹•æ›è¡Œé‚è¼¯
    async function typeText(element, text, speed = 30) {
      const breakChars = ["ã€‚", "ï¼", "ï¼Ÿ", "!", "?", "ï¼Œ", ",", "\n"];
      let buffer = "";

      for (let i = 0; i < text.length; i++) {
        buffer += text[i];
        element.innerHTML = buffer;

        // æ›è¡Œæ¢ä»¶ï¼šæ¨™é»ç¬¦è™Ÿ + é©åº¦å¥é•·
        if (breakChars.includes(text[i]) && Math.random() < 0.4) {
          buffer += "\n";
          element.innerHTML = buffer;
        }

        chatBox.scrollTop = chatBox.scrollHeight;
        await new Promise((resolve) => setTimeout(resolve, speed));
      }
    }

    async function sendMessage() {
      if (isTyping) return; // âœ… è‹¥ AI æ­£åœ¨å›è¦†ï¼Œä¸å…è¨±æ–°è¼¸å…¥
      const msg = userInput.value.trim();
      if (!msg) return;

      addBubble("user", msg);
      userInput.value = "";
      sendBtn.disabled = true;
      userInput.disabled = true;
      userInput.style.opacity = "0.6";
      isTyping = true;

      addTyping();

      try {
        const { data } = await supabase.auth.getSession();
        const token = data.session?.access_token;

        const res = await fetch(API_URL, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${token}`,
          },
          body: JSON.stringify({
            userId: data.session?.user.id || "guest",
            message: msg,
          }),
        });

        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const result = await res.json();
        removeTyping();

        const botBubble = addBubble("bot", "");
        const reply = result.reply || "æˆ‘æš«æ™‚æ²’å›æ‡‰ï¼Œè«‹ç¨å¾Œå†è©¦ ğŸ’¬";
        await typeText(botBubble, reply, 35);
      } catch (e) {
        console.error("âŒ Chat Error:", e);
        removeTyping();
        addBubble("bot", "âš ï¸ å‡ºéŒ¯äº†ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚");
      } finally {
        sendBtn.disabled = false;
        userInput.disabled = false;
        userInput.style.opacity = "1";
        isTyping = false; // âœ… å›è¦†å®Œæˆå¾Œæ‰èƒ½è¼¸å…¥ä¸‹ä¸€é¡Œ
      }
    }

    sendBtn.onclick = sendMessage;
    userInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") sendMessage();
    });
  </script>
</body>
</html>