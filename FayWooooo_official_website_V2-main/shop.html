
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FayWooooo å®˜æ–¹ç¶²ç«™</title>
  <base href="/shop.html">
  <link rel="stylesheet" href="css/style.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/js/all.min.js"></script>
</head>
<body>
  <header class="topbar">
    <div class="logo"><i class="fa-solid fa-gift"></i> Fayå¹£å…Œæ›ä¸­å¿ƒ</div>
    <nav class="navbar">
      <span>
        <a href="https://mail.google.com/mail/?view=cm&fs=1&to=faywooooo@gmail.com&su=FayWoooooå®¢æœè¯çµ¡&body=æ‚¨å¥½ï¼Œæˆ‘æƒ³è©¢å•é—œæ–¼..."
           target="_blank" style="color:black;text-decoration:none;display:flex;font-weight:bold;">
          è¯çµ¡ FayWooooo å®¢æœ
        </a>
      </span>
      <span id="coinDisplay"><i class="fa-solid fa-coins"></i>&nbsp;Fayå¹£ï¼šè¼‰å…¥ä¸­...</span>
      <a href="index.html"><i class="fa-solid fa-house"></i> é¦–é </a>
    </nav>
  </header>
<div class="mobile-nav">
  <a href="index.html"><i class="fas fa-home"></i>é¦–é </a>
  <a href="shop.html" class="active"><i class="fas fa-store"></i>å…Œæ›</a>
  <a href="live.html"><i class="fas fa-video"></i>ç›´æ’­</a>
  <span id="coinDisplayMobile" style="color: black;"><i class="fa-solid fa-coins"></i>&nbsp;--</span>
</div>

  <main class="container2">

    <div id="notification" class="notification"></div>

    <!-- ğŸ¯ æ¯æ—¥ç™»å…¥çå‹µ -->
    <center>
      <section class="card2" style="margin-bottom: 25px;">
        <h2><i class="fa-solid fa-calendar-check"></i> 30 å¤©é€£çºŒç™»å…¥çå‹µ</h2>
        <div class="reward-scroll">
          <div id="dailyRewardList" class="reward-days"></div>
        </div>
        <button id="claimDaily" class="main-btn"><i class="fa-solid fa-gift"></i> é ˜å–ä»Šæ—¥çå‹µ</button>
        <p id="dailyStatus" style="margin-top:10px;color:gold;"></p>
      </section>
    </center>

    <!-- ğŸ Fayå¯¶ç®± -->
    <center><section class="card2">
      <h2><i class="fa-solid fa-box"></i> Fayå¯¶ç®±</h2>
      <p>æ¯æ¬¡é–‹å•Ÿéœ€ 100 Fayå¹£ï¼Œé–‹æ»¿ 10 ç®±å¯è§£é– Discord å°ˆå±¬èº«åˆ†çµ„(åƒ…é™ç¬¬1æ¬¡èƒ½ç²å–ï¼Œç¨±è™Ÿç‚º:å¯¶ç®±å¯Œç¿)ï¼</p>
      <div class="box-container">
        <div class="box" id="boxElement">ğŸ</div>
      </div>
      <p id="result" style="margin-top:15px;color:gold;"></p>

      <div id="progressText" style="margin-top:8px;">è¼‰å…¥ä¸­...</div>
      <div id="progressBar" style="background:rgba(255,255,255,0.1);border-radius:10px;height:12px;margin-top:8px;max-width:400px;">
        <div id="progressFill" style="height:100%;width:0%;background:gold;border-radius:10px;"></div>
      </div>
    </section></center>

    <!-- ğŸ† çå‹µæ¸…å–® -->
    <h2 style="margin-top:60px;"><i class="fa-solid fa-trophy"></i> çå‹µæ¸…å–®</h2>
    <div id="rewardList">è¼‰å…¥ä¸­...</div>
  </main>

  <footer>
    <p>Â© 2025 FayWooooo å®˜æ–¹ç¶²ç«™ | <a href="https://www.youtube.com/@FayWooooo" target="_blank">YouTube</a></p>
  </footer>

  <script type="module">
    import { supabase } from "./js/supabase-config.js";
    const API_URL = "https://wcqutexugvrgnyusnkpv.supabase.co/functions/v1/rewards";

    const result = document.getElementById("result");
    const progressText = document.getElementById("progressText");
    const progressFill = document.getElementById("progressFill");
    const rewardList = document.getElementById("rewardList");
    const coinDisplay = document.getElementById("coinDisplay");
const coinDisplayMobile = document.getElementById("coinDisplayMobile");
    const claimBtn = document.getElementById("claimDaily");
    const dailyStatus = document.getElementById("dailyStatus");
    const dailyRewardList = document.getElementById("dailyRewardList");

    // âœ… Session
    async function getUserSession() {
      const { data } = await supabase.auth.getSession();
      const session = data.session;
      if (!session) {
        showNotification("è«‹å…ˆç™»å…¥ï¼", "error");
        location.replace("index.html");
        throw new Error("No session");
      }
      return { email: session.user.email, token: session.access_token, id: session.user.id };
    }

    // âœ… é¡¯ç¤ºé€šçŸ¥
    function showNotification(message, type = "success") {
      const notification = document.getElementById("notification");
      notification.textContent = message;
      notification.className = `notification ${type}`;
      notification.classList.add("show");
      setTimeout(() => {
        notification.classList.remove("show");
      }, 3000);
    }

    // âœ… Fayå¹£é¡¯ç¤º
    async function loadFaycoins() {
  try {
    const { email } = await getUserSession();
    const { data } = await supabase.from("profiles").select("faycoins").eq("email", email).maybeSingle();

    const coinText = data?.faycoins !== undefined
      ? `<i class="fa-solid fa-coins"></i>&nbsp;Fayå¹£ï¼š${data.faycoins}`
      : "âš ï¸ ç„¡æ³•è¼‰å…¥ Fay å¹£";

    coinDisplay.innerHTML = coinText;
    coinDisplayMobile.innerHTML = coinText;

  } catch {
    coinDisplay.textContent = "âš ï¸ å°šæœªç™»å…¥";
    coinDisplayMobile.textContent = "âš ï¸ å°šæœªç™»å…¥";
  }
}


    // âœ… å³æ™‚ç›£è½ Fay å¹£è®ŠåŒ–
    async function watchFaycoins() {
      try {
        const { id } = await getUserSession();
        supabase.channel("realtime-faycoins")
          .on("postgres_changes", { event: "UPDATE", schema: "public", table: "profiles", filter: `id=eq.${id}` },
            (payload) => {
              const newCoins = payload.new.faycoins;
              coinDisplay.innerHTML = `<i class="fa-solid fa-coins"></i>&nbsp;Fayå¹£ï¼š${newCoins}`;
coinDisplayMobile.innerHTML = `<i class="fa-solid fa-coins"></i>&nbsp;Fayå¹£ï¼š${newCoins}`;
            })
          .subscribe();
      } catch (err) { console.error("å•Ÿç”¨å³æ™‚ç›£è½å¤±æ•—ï¼š", err); }
    }

    // âœ… å¯¶ç®±åŠŸèƒ½
    document.getElementById("boxElement").onclick = async () => {
      try {
        const { email, token } = await getUserSession();
        result.innerHTML = `<i class="fa-solid fa-spinner fa-spin"></i> äº¤æ˜“è™•ç†ä¸­...`;
        const res = await fetch(API_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json", "Authorization": `Bearer ${token}` },
          body: JSON.stringify({ action: "openBox", email })
        });
        const data = await res.json();
        if (data.success) {
          result.innerHTML = `ğŸ‰ ç²å¾— <b>${data.reward}</b>`;
          if (data.special) result.innerHTML += "<br>ğŸŒŸ ç‰¹åˆ¥çå‹µå·²è§£é–ï¼";
          progressText.textContent = `å·²é–‹å•Ÿ ${data.progress}/10 ç®±`;
          progressFill.style.width = `${data.progress * 10}%`;
          // æ·»åŠ 3Då‹•ç•«
          const boxEl = document.getElementById("boxElement");
          boxEl.classList.add("box-animation");
          setTimeout(() => boxEl.classList.remove("box-animation"), 1000);
        } else {
          showNotification(`âŒ ${data.error || "é–‹ç®±å¤±æ•—"}`, "error");
        }
      } catch {
        showNotification("âš ï¸ è«‹å…ˆç™»å…¥å†å˜—è©¦é–‹ç®±ã€‚", "error");
      }
    };

    // âœ… è¼‰å…¥çå‹µæ¸…å–®
    async function loadRewards() {
      try {
        const { email, token } = await getUserSession();
        const res = await fetch(API_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json", "Authorization": `Bearer ${token}` },
          body: JSON.stringify({ action: "listRewards", email })
        });
        const data = await res.json();
        if (data.success) {
          rewardList.innerHTML = data.rewards.map(r => `
            <div class="reward-card" data-id="${r.id}" data-title="${r.title}">
              <div class="reward-info">
                <div class="reward-title">${r.title}</div>
                <div class="reward-desc">${r.description || ""}</div>
              </div>
              <div class="reward-action">
                <div class="reward-price"><i class="fa-solid fa-coins"></i> ${r.price}</div>
                <button class="buy-btn">è³¼è²·</button>
              </div>
            </div>
          `).join("");
          document.querySelectorAll(".buy-btn").forEach(btn => {
            btn.addEventListener("click", async e => {
              const parent = e.target.closest(".reward-card");
              const id = parent.dataset.id, title = parent.dataset.title;
              if (!confirm(`ç¢ºèªè³¼è²·ã€Œ${title}ã€å—ï¼Ÿ`)) return;
              const { email, token } = await getUserSession();
              const res = await fetch(API_URL, {
                method: "POST",
                headers: { "Content-Type": "application/json", "Authorization": `Bearer ${token}` },
                body: JSON.stringify({ action: "buyReward", email, rewardId: id })
              });
              const result = await res.json();
              showNotification(result.success ? `âœ… ${result.message}` : `âŒ ${result.error}`, result.success ? "success" : "error");
            });
          });
        } else rewardList.textContent = "âŒ ç„¡æ³•è¼‰å…¥çå‹µã€‚";
      } catch { rewardList.textContent = "âš ï¸ è«‹ç™»å…¥ä»¥è¼‰å…¥çå‹µã€‚"; }
    }

    // âœ… é–‹ç®±é€²åº¦
    async function loadProgress() {
      try {
        const { email, token } = await getUserSession();
        const res = await fetch(API_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json", "Authorization": `Bearer ${token}` },
          body: JSON.stringify({ action: "progress", email })
        });
        const data = await res.json();
        if (data.success) {
          progressText.textContent = `å·²é–‹å•Ÿ ${data.progress}/10 ç®±`;
          progressFill.style.width = `${data.progress * 10}%`;
        } else progressText.textContent = "âš ï¸ ç„¡æ³•å–å¾—é€²åº¦";
      } catch (err) { console.error("loadProgress éŒ¯èª¤:", err); }
    }

    // âœ… æ¯æ—¥ç™»å…¥çå‹µåŠŸèƒ½
    const dailyRewards = Array.from({ length: 30 }, (_, i) => ({
      day: i + 1,
      reward: i === 29 ? "Lineç¾¤ç®¡ç†å“¡" : "15 Fayå¹£"
    }));

    async function loadDailyRewards() {
      const { email, token } = await getUserSession();
      const res = await fetch(API_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json", "Authorization": `Bearer ${token}` },
        body: JSON.stringify({ action: "getStreakInfo", email })
      });
      const data = await res.json();
      if (!data.success) return;

      const streak = data.streak || 0;
      const lastLogin = data.lastLogin ? new Date(data.lastLogin) : null;
      const now = new Date();
      const today16 = new Date(); today16.setHours(16,0,0,0);

      dailyRewardList.innerHTML = "";
      dailyRewards.forEach(r => {
        const div = document.createElement("div");
        div.className = "reward-day";
        div.innerHTML = `
          <div class="day-num">Day ${r.day}</div>
          <div>${r.reward}</div>
          <small id="time-${r.day}"></small>
        `;
        if (r.day <= streak) {
          div.classList.add("claimed");
          div.querySelector("small").textContent = "âœ… å·²é ˜å–";
        } else if (r.day === streak + 1) {
          if (lastLogin) {
            const diff = today16 - now;
            if (diff <= 0) div.querySelector("small").textContent = "ğŸŸ¢ å¯é ˜å–";
            else {
              const hrs = Math.floor(diff / 3600000);
              const mins = Math.floor((diff % 3600000) / 60000);
              div.querySelector("small").textContent = `â³ ${hrs}å°æ™‚${mins}åˆ†å¾Œå¯é ˜`;
            }
          } else div.querySelector("small").textContent = "ğŸŸ¢ å¯é ˜å–";
        } else {
          div.classList.add("locked");
          div.querySelector("small").textContent = "ğŸ”’ å°šæœªè§£é–";
        }
        dailyRewardList.appendChild(div);
      });

      if (streak >= 30) {
        claimBtn.style.display = "none";
        dailyStatus.textContent = "ğŸ‰ å·²å®Œæˆ30å¤©é€£çºŒç™»å…¥çå‹µï¼";
      }
    }

    claimBtn.addEventListener("click", async () => {
      const { email, token } = await getUserSession();
      const res = await fetch(API_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json", "Authorization": `Bearer ${token}` },
        body: JSON.stringify({ action: "dailyLogin", email })
      });
      const data = await res.json();
      dailyStatus.textContent = data.message;
      await loadDailyRewards();
    });

    // ğŸš€ å•Ÿå‹•
    await loadFaycoins();
    await loadRewards();
    await loadProgress();
    await loadDailyRewards();
    await watchFaycoins();
  </script>
</body>
</html>
