<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>FayAI Chat - å¾Œç«¯é©…å‹• UI</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/js/all.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  
  <style>
    /* ===========================================
    âš ï¸ CSS æ¨£å¼éƒ¨åˆ†ä¿æŒä¸è®Š
    ===========================================
    */
    /* å…¨å±€è¨­ç½® */
    :root {
      --color-primary: #34ff85; /* Fay AI ç¶  */
      --color-secondary: #00bcd4; /* Line è— */
      --color-bg-dark: #000814;
      --color-bg-light: #0a1a2f;
      --color-delete: #ff5555;
      --color-reply: #777;
    }

    body {
      margin: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: var(--color-bg-dark);
      color: #fff;
    }

    /* é ‚éƒ¨å°èˆªæ¬„ (TopBar) - ä¿æŒä¸€è‡´ */
    .topbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 20px;
      background-color: var(--color-bg-light);
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
      flex-shrink: 0; 
    }
    .logo {
      font-size: 1.5rem;
      font-weight: bold;
      color: var(--color-primary);
    }
    .navbar a {
      color: #fff;
      text-decoration: none;
      margin-left: 15px;
      opacity: 0.8;
      transition: opacity 0.2s;
    }
    .navbar a:hover {
      opacity: 1;
    }

    /* ä¸»å®¹å™¨ï¼šå…©æ¬„ä½ˆå±€ */
    main {
      display: flex;
      height: calc(100vh - 56px); 
    }

    /* å·¦å´ï¼šèŠå¤©åˆ—è¡¨ (Line é¢¨æ ¼å´é‚Šæ¬„) */
    .chat-list-sidebar {
      width: 300px;
      background-color: #0a131b; 
      border-right: 1px solid rgba(255, 255, 255, 0.05);
      overflow-y: auto;
      flex-shrink: 0;
    }

    .sidebar-header {
      display: flex; 
      justify-content: space-between;
      align-items: center;
      padding: 15px;
      font-size: 1.2rem;
      font-weight: 600;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    .sidebar-header button {
        background: none;
        border: none;
        color: var(--color-primary);
        font-size: 1.2rem;
        cursor: pointer;
        transition: color 0.2s;
    }
    .sidebar-header button:hover {
        color: #56ffa0;
    }

    /* èŠå¤©å®¤å’Œå¥½å‹è«‹æ±‚å…±åŒæ¨£å¼ */
    .chat-item, .request-item {
      display: flex;
      align-items: center;
      padding: 15px;
      cursor: pointer;
      transition: background-color 0.2s;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }
    .chat-item:hover, .chat-item.active {
      background-color: rgba(255, 255, 255, 0.1);
    }
    /* å¥½å‹è«‹æ±‚ç‰¹å®šæ¨£å¼ */
    .request-section {
        border-top: 1px solid rgba(255, 255, 255, 0.1);
    }
    .request-title {
        padding: 8px 15px;
        font-size: 0.9rem;
        color: var(--color-delete);
        background-color: rgba(255, 85, 85, 0.1);
    }
    .request-actions button {
        background: var(--color-primary);
        color: #000;
        border: none;
        padding: 5px 10px;
        border-radius: 5px;
        margin-left: 5px;
        font-size: 0.8rem;
        cursor: pointer;
    }
    .request-actions button:hover {
        opacity: 0.8;
    }


    .chat-avatar {
      width: 45px;
      height: 45px;
      border-radius: 50%;
      background: var(--color-primary);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      margin-right: 15px;
      color: #000;
      flex-shrink: 0;
    }
    .chat-info {
      flex-grow: 1;
      min-width: 0;
    }
    .chat-name {
      font-weight: 604;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .chat-last-message {
      font-size: 0.9rem;
      color: rgba(255, 255, 255, 0.6);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* å³å´ï¼šèŠå¤©è¦–çª— */
    .chat-window {
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    .chat-header {
      padding: 15px 20px;
      background-color: var(--color-bg-light);
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      font-size: 1.2rem;
      font-weight: 600;
      flex-shrink: 0;
    }

    .chat-box {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 15px; 
      scroll-behavior: smooth;
      background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><rect x="0" y="0" width="100" height="100" fill="%23000814"/><circle cx="50" cy="50" r="1" fill="%230a131b"/></svg>');
    }

    /* è¨Šæ¯æ°£æ³¡ (Line é¢¨æ ¼) */
    .message-container {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      max-width: 80%;
    }
    
    .message-container.from-user {
      align-self: flex-end;
      flex-direction: row-reverse;
      max-width: 75%;
    }
    
    .message-avatar {
      width: 35px;
      height: 35px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.2);
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.9rem;
      flex-shrink: 0;
    }
    
    .message-content-wrapper {
        display: flex;
        flex-direction: column;
    }

    .bubble {
      padding: 10px 14px;
      border-radius: 10px; 
      font-size: 15px;
      line-height: 1.5;
      word-break: break-word;
      animation: fadeIn 0.3s ease;
      white-space: pre-wrap;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
    }
    
    .from-user .bubble {
      background-color: var(--color-primary); 
      color: #000;
      border-top-right-radius: 0;
    }
    
    .from-bot .bubble {
      background-color: #38424a; /* Line ç°è‰²æ°£æ³¡ */
      color: #fff;
      border-top-left-radius: 0;
    }
    .bubble a {
        color: var(--color-secondary);
        text-decoration: underline;
    }
    .bubble a:hover {
        color: var(--color-primary);
    }

    /* æ‰“å­—ä¸­å‹•ç•« */
    .typing-indicator {
        align-self: flex-start;
        display: none; /* é è¨­éš±è— */
        padding: 10px 16px;
        border-radius: 10px;
        border-top-left-radius: 0;
        background-color: #38424a;
        width: auto;
        color: #fff;
        font-style: italic;
    }
    /* å¯¦éš›çš„å‹•ç•«é» */
    .dot {
        width: 6px;
        height: 6px;
        border-radius: 50%;
        background-color: #fff;
        display: inline-block;
        margin: 0 1px;
        animation: loading 1.5s infinite;
    }
    .dot:nth-child(2) { animation-delay: 0.5s; }
    .dot:nth-child(3) { animation-delay: 1s; }

    @keyframes loading {
        0%, 80%, 100% { transform: scale(0); }
        40% { transform: scale(1); }
    }


    /* è¼¸å…¥æ¡† */
    .chat-input {
      display: flex;
      align-items: center;
      padding: 10px;
      background: var(--color-bg-light);
      border-top: 1px solid rgba(255, 255, 255, 0.1);
      flex-shrink: 0;
    }

    .chat-input input {
      flex: 1;
      padding: 12px;
      border: none;
      border-radius: 20px; 
      background: rgba(255,255,255,0.1);
      color: white;
      outline: none;
      transition: opacity 0.3s;
    }

    .chat-input button {
      margin-left: 10px;
      width: 45px;
      height: 45px;
      border-radius: 50%;
      border: none;
      background: var(--color-primary);
      color: #000;
      font-size: 1.1rem;
      cursor: pointer;
      transition: 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .chat-input button:hover {
      background: #56ffa0;
      transform: scale(1.05);
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(8px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    /* Modal å½ˆçª—æ¨£å¼ (ä¸è®Š) */
    .modal-overlay {
      display: none; 
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(5px);
      align-items: center;
      justify-content: center;
      animation: fadeIn 0.3s;
    }

    .modal-content {
      background-color: var(--color-bg-light);
      margin: auto;
      padding: 25px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      width: 90%;
      max-width: 450px;
      border-radius: 10px;
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.5);
      position: relative;
    }

    .modal-close {
      color: #aaa;
      position: absolute;
      top: 10px;
      right: 20px;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
    }
    .modal-close:hover,
    .modal-close:focus {
      color: white;
    }

    .settings-section {
      margin-bottom: 20px;
    }
    .settings-section h2 {
      color: var(--color-primary);
      border-bottom: 1px solid var(--color-primary);
      padding-bottom: 5px;
      margin-top: 0;
    }
    .settings-section h3 {
      color: #eee;
      margin-top: 20px;
    }
    .settings-section label {
      display: block;
      margin-top: 10px;
      font-size: 0.9rem;
      color: #ccc;
    }
    
    .modal-content input[type="text"] {
      width: calc(100% - 24px); 
      padding: 12px;
      border: none;
      border-radius: 8px;
      background: rgba(255,255,255,0.1);
      color: white;
      outline: none;
      margin-top: 5px;
    }
    
    .modal-content button {
      margin-top: 15px;
      padding: 10px 15px;
      border-radius: 8px;
      border: none;
      background: var(--color-primary);
      color: #000;
      font-weight: bold;
      cursor: pointer;
      transition: 0.2s;
    }
    .modal-content button:hover {
      background: #56ffa0;
    }
    .modal-content button:disabled {
      background: #555;
      cursor: not-allowed;
    }

    /* è¨Šæ¯å‹•ä½œæŒ‰éˆ• (åˆªé™¤/å›è¦†/Emoji) */
    .message-actions {
        display: flex;
        align-items: center;
        opacity: 0; /* é è¨­éš±è— */
        transition: opacity 0.2s;
        margin-top: 4px;
        font-size: 0.8rem;
    }
    .from-user .message-actions {
        justify-content: flex-end;
    }
    .message-container:hover .message-actions {
        opacity: 1; /* æ»‘éæ™‚é¡¯ç¤º */
    }

    .action-btn {
        background: none;
        border: none;
        cursor: pointer;
        padding: 3px 6px;
        border-radius: 5px;
        margin-left: 5px;
        color: var(--color-reply);
    }
    .action-btn:hover {
        background: rgba(255, 255, 255, 0.1);
        color: white;
    }
    .delete-btn {
        color: var(--color-delete);
    }
  </style>
</head>
<body>
  <header class="topbar">
    <div class="logo"><i class="fa-solid fa-comments"></i> Fay AI èŠå¤©å®¤</div>
    <nav class="navbar">
      <a href="index.html"><i class="fa-solid fa-house"></i> é¦–é </a>
      <a href="#" id="settingsBtn"><i class="fa-solid fa-gear"></i> è¨­å®š</a>
    </nav>
  </header>

  <main>
    <div class="chat-list-sidebar" id="chatListSidebar">
      <div class="sidebar-header">
        <span>æœ€è¿‘èŠå¤©</span>
        <button id="addFriendBtn" title="æ–°å¢å¥½å‹"><i class="fa-solid fa-user-plus"></i></button>
      </div>
      
      <div class="chat-item active" data-chat-id="fay_ai_chat" data-chat-name="FayAI èªæ„å¼•æ“" data-chat-type="ai">
        <div class="chat-avatar" style="background: var(--color-primary);"><i class="fa-solid fa-robot"></i></div>
        <div class="chat-info">
          <div class="chat-name">FayAI èªæ„å¼•æ“</div>
          <div class="chat-last-message" id="ai_last_msg">å—¨å—¨ï¼ğŸ’š å¾ˆé«˜èˆˆèƒ½èŠèŠ...</div>
        </div>
      </div>
      
      <div id="friendRequestsSection" class="request-section">
        </div>
      
      <div id="p2pChatList">
        </div>
      
    </div>

    <div class="chat-window">
      <div class="chat-header" id="chatHeader">FayAI èªæ„å¼•æ“</div>
      <div class="chat-box" id="chatBox">
        </div>
        
        <div id="typingIndicator" class="typing-indicator">
            <span id="typingName">FayAI</span> æ­£åœ¨è¼¸å…¥...
            <span class="dot"></span><span class="dot"></span><span class="dot"></span>
        </div>
        
      <div class="chat-input">
        <input type="text" id="userInput" placeholder="è¼¸å…¥è¨Šæ¯..." />
        <button id="sendBtn" title="é€å‡º"><i class="fa-solid fa-paper-plane"></i></button>
      </div>
    </div>
  </main>

  <div id="settingsModal" class="modal-overlay">
    <div class="modal-content">
      <span class="modal-close" id="modalCloseBtn">&times;</span>
      
      <div class="settings-section">
        <h2><i class="fa-solid fa-gear"></i> è¨­å®š</h2>
        
        <h3>å€‹äººè³‡æ–™</h3>
        <p style="color: #ccc;">æ‚¨çš„ Email: <strong id="profileEmail" style="color: white;">...loading</strong></p>
        <label for="profileUsername">æ‚¨çš„å¥½å‹ ID (Username):</label>
        <input type="text" id="profileUsername" placeholder="è¨­å®šæ‚¨çš„å¥½å‹ ID">
        <button id="saveProfileBtn">å„²å­˜è³‡æ–™</button>
      </div>
      
      <hr style="border-color: rgba(255,255,255,0.1);">
      
      <div class="settings-section">
        <h3><i class="fa-solid fa-user-plus"></i> æ–°å¢å¥½å‹</h3>
        <label for="friendUsernameInput">å¥½å‹ ID (Username):</label>
        <input type="text" id="friendUsernameInput" placeholder="è¼¸å…¥å°æ–¹çš„ Username">
        <button id="addFriendSubmitBtn">é€å‡ºå¥½å‹é‚€è«‹</button>
      </div>

    </div>
  </div>

<script type="module">
    // å¼•å…¥ Supabase Config (å‡è¨­æ‚¨æœ‰é€™å€‹æª”æ¡ˆ)
    import { supabase } from "./js/supabase-config.js"; 

    // ===========================================
    // âœ… URL å®šç¾© (ç¶å®šå¾Œç«¯ Edge Function)
    // ===========================================
    const CHAT_HANDLER_URL = "https://wcqutexugvrgnyusnkpv.supabase.co/functions/v1/chat-handler";
    const FAY_AI_API_URL = "https://wcqutexugvrgnyusnkpv.supabase.co/functions/v1/fayai-smart";

    // ===========================================
    // âœ… é¡å‹å®šç¾© (æ¨¡æ“¬ TypeScript çµæ§‹)
    // ===========================================
    
    /** @typedef {'p2p' | 'group' | 'ai'} ChatType */
    /**
     * @typedef {object} SupabaseMessage
     * @property {number} id
     * @property {string} chat_id
     * @property {string} user_id
     * @property {string} content
     * @property {string} created_at
     * @property {{username: string, avatar_url: string}|null} [profiles] - ç™¼é€è€… profile
     */
     /**
     * @typedef {object} FriendRequest
     * @property {string} id
     * @property {string} user_id_1 - é‚€è«‹è€… ID
     * @property {string} user_id_2 - è¢«é‚€è«‹è€… ID (å³ç•¶å‰ä½¿ç”¨è€…)
     * @property {string} status - 'pending'
     * @property {{username: string}|null} profiles - é‚€è«‹è€…çš„ profile
     */
    
    // ===========================================
    // âœ… UI å…ƒç´ é¸å– (ä¿æŒä¸è®Š)
    // ===========================================
    const chatBox = document.getElementById("chatBox");
    const userInput = document.getElementById("userInput");
    const sendBtn = document.getElementById("sendBtn");
    const chatHeader = document.getElementById("chatHeader");
    const chatListSidebar = document.getElementById("chatListSidebar");
    const p2pChatList = document.getElementById("p2pChatList");
    const friendRequestsSection = document.getElementById("friendRequestsSection");
    const addFriendBtn = document.getElementById("addFriendBtn");
    const settingsBtn = document.getElementById("settingsBtn");
    const typingIndicator = document.getElementById("typingIndicator");

    // Modal å…ƒç´ 
    const settingsModal = document.getElementById("settingsModal");
    const modalCloseBtn = document.getElementById("modalCloseBtn");
    const profileEmail = document.getElementById("profileEmail");
    const profileUsername = document.getElementById("profileUsername");
    const saveProfileBtn = document.getElementById("saveProfileBtn");
    const friendUsernameInput = document.getElementById("friendUsernameInput");
    const addFriendSubmitBtn = document.getElementById("addFriendSubmitBtn");

    // ===========================================
    // âœ… ç‹€æ…‹ç®¡ç† (ä¿æŒä¸è®Š)
    // ===========================================
    let isTyping = false; 
    let currentChatId = "fay_ai_chat"; 
    let currentChatType = "ai";
    let currentUser = null; 
    let realtimeChannel = null; 
    let friendRequestInterval = null; 

    // ===========================================
    // âœ… UI è¼”åŠ©å‡½æ•¸ (åªè™•ç† DOM æ“ä½œï¼Œä¿æŒä¸è®Š)
    // ===========================================
    
    function linkify(text) {
        const urlRegex = /(\b(https?):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/ig;
        return text.replace(urlRegex, (url) => {
            return `<a href="${url}" target="_blank" rel="noopener noreferrer">${url}</a>`;
        });
    }

    /**
     * @param {SupabaseMessage} message 
     * @param {boolean} [prepend=false]
     */
    function addBubble(message, prepend = false) {
      if (document.querySelector(`[data-message-id="${message.id}"]`)) return;

      const isUser = message.user_id === currentUser?.id;
      const role = isUser ? 'user' : 'bot'; 
      
      const container = document.createElement("div");
      container.className = `message-container ${role === "user" ? "from-user" : "from-bot"}`;
      container.dataset.messageId = message.id; 
      
      const messageWrapper = document.createElement("div");
      messageWrapper.className = "message-content-wrapper";

      const avatar = document.createElement("div");
      avatar.className = "message-avatar";
      
      let avatarText = '??';
      const senderProfile = isUser ? currentUser?.profile : message.profiles;

      if (senderProfile?.username) {
        avatarText = senderProfile.username.substring(0, 2);
      } else if (role === 'bot') {
         avatar.innerHTML = '<i class="fa-solid fa-robot"></i>';
      } else {
         avatarText = isUser ? 'ME' : '??';
      }
      if (role !== 'bot') {
          avatar.textContent = avatarText;
      }
      
      const bubble = document.createElement("div");
      bubble.className = "bubble";
      
      let content = message.content.replace(/\n/g, '<br>');
      content = linkify(content);
      bubble.innerHTML = content;
      
      // è¨Šæ¯å‹•ä½œåˆ—
      const actions = document.createElement("div");
      actions.className = "message-actions";

      // 1. åˆªé™¤/æ”¶å› (ç¶å®šæ–°çš„ deleteMessage å‡½å¼ï¼Œè©²å‡½å¼å‘¼å« Edge Function)
      if (isUser && currentChatType !== 'ai') {
        const deleteBtn = document.createElement("button");
        deleteBtn.className = "action-btn delete-btn";
        deleteBtn.innerHTML = '<i class="fa-solid fa-trash"></i> æ”¶å›';
        deleteBtn.onclick = () => window.deleteMessage(message.id);
        actions.appendChild(deleteBtn);
      }
      
      // 2. å›è¦†æŒ‰éˆ• (ç¶å®šæ–°çš„ handleReply å‡½å¼ï¼Œè©²å‡½å¼å‘¼å« Edge Function)
      if (currentChatType !== 'ai') {
        const replyBtn = document.createElement("button");
        replyBtn.className = "action-btn reply-btn";
        replyBtn.innerHTML = '<i class="fa-solid fa-reply"></i> å›è¦†';
        replyBtn.onclick = () => window.handleReply(message.id);
        actions.appendChild(replyBtn);
      }
      
      // 3. Emoji åæ‡‰æŒ‰éˆ• (ç¶å®šæ–°çš„ handleEmoji å‡½å¼ï¼Œè©²å‡½å¼å‘¼å« Edge Function)
      const emojiBtn = document.createElement("button");
      emojiBtn.className = "action-btn emoji-btn";
      emojiBtn.innerHTML = '<i class="fa-regular fa-face-smile"></i>';
      emojiBtn.onclick = () => window.handleEmoji(message.id);
      actions.appendChild(emojiBtn);
      
      // çµ„åˆçµæ§‹
      messageWrapper.appendChild(bubble);
      messageWrapper.appendChild(actions);
      
      container.appendChild(avatar);
      container.appendChild(messageWrapper);
      
      if (prepend) {
        chatBox.prepend(container); 
      } else {
        chatBox.appendChild(container); 
        scrollToBottom();
      }
    }

    function addChatItemToSidebar(id, name, type, lastMessage) {
        const item = document.createElement("div");
        item.className = "chat-item";
        item.dataset.chatId = id;
        item.dataset.chatName = name;
        item.dataset.chatType = type;
        
        const avatarIcon = type === 'p2p' ? 'fa-user' : 'fa-users';
        
        item.innerHTML = `
          <div class="chat-avatar" style="background: #2a9d8f;"><i class="fa-solid ${avatarIcon}"></i></div>
          <div class="chat-info">
            <div class="chat-name">${name}</div>
            <div class="chat-last-message" id="last_msg_${id}">${lastMessage || 'ç„¡è¨Šæ¯'}</div>
          </div>
        `;
        p2pChatList.appendChild(item);
    }
    
    function scrollToBottom() {
      chatBox.scrollTop = chatBox.scrollHeight;
    }
    
    function showTypingIndicator(username = 'FayAI') {
        document.getElementById("typingName").textContent = username;
        typingIndicator.style.display = 'flex';
        scrollToBottom();
    }
    
    function hideTypingIndicator() {
        typingIndicator.style.display = 'none';
    }


    // ===========================================
    // âœ… è¼”åŠ©å·¥å…· (Helper: å‘¼å« Edge Function)
    // ===========================================
    
    /**
     * é€šç”¨å‡½å¼ï¼šä½¿ç”¨ç”¨æˆ¶çš„ JWT å‘¼å« Chat Handler Edge Function
     * @param {string} action - 'send' | 'delete' | 'reply' | 'react' | 'add_friend'
     * @param {object} [body={}] - å‚³éçµ¦ Edge Function çš„åƒæ•¸
     */
    async function callChatHandler(action, body = {}) {
        const { data } = await supabase.auth.getSession();
        const token = data.session?.access_token;
        if (!token) throw new Error("Authentication token not available.");

        const res = await fetch(CHAT_HANDLER_URL, {
            method: "POST",
            headers: { 
                "Content-Type": "application/json", 
                "Authorization": `Bearer ${token}` 
            },
            body: JSON.stringify({ action, ...body }),
        });
        
        if (res.status === 401) {
            alert("âŒ é©—è­‰å¤±æ•—ã€‚è«‹é‡æ–°ç™»å…¥ã€‚");
            supabase.auth.signOut();
            return;
        }
        
        const result = await res.json();
        // Edge Function å¯èƒ½å›å‚³å¸¶æœ‰ error å±¬æ€§çš„ JSON
        if (result.error) throw new Error(result.error);
        return result;
    }


    // ===========================================
    // âœ… è¨Šæ¯æ ¸å¿ƒé‚è¼¯ (Edge Function é©…å‹•)
    // ===========================================

    /**
     * @param {number} messageId
     * @global
     */
    window.deleteMessage = async function(messageId) {
        if (!confirm("ç¢ºå®šè¦æ”¶å›é€™å‰‡è¨Šæ¯å—ï¼Ÿ")) return;
        
        try {
            // å‘¼å« Edge Function è™•ç†åˆªé™¤æ“ä½œ
            await callChatHandler('delete', { message_id: messageId });
            // Realtime DELETE æœƒè™•ç† UI ç§»é™¤
        } catch (error) {
            console.error("åˆªé™¤å¤±æ•—:", error);
            alert(`åˆªé™¤å¤±æ•—: ${error.message}`);
        }
    }
    
    /**
     * @param {number} messageId
     * @global
     */
    window.handleReply = async function(messageId) {
        const replyContent = prompt("è«‹è¼¸å…¥æ‚¨çš„å›è¦†å…§å®¹:");
        if (!replyContent || !replyContent.trim()) return;

        try {
            await callChatHandler('reply', { 
                chat_id: currentChatId, 
                reply_to: messageId, 
                content: replyContent.trim()
            });
            alert("å›è¦†è¨Šæ¯å·²ç™¼é€ï¼");
        } catch (error) {
            alert(`å›è¦†å¤±æ•—: ${error.message}`);
        }
    }
    
    /**
     * @param {number} messageId
     * @global
     */
    window.handleEmoji = async function(messageId) {
        const emoji = prompt("è¼¸å…¥ä¸€å€‹ Emoji è¡¨æƒ… (ä¾‹å¦‚: ğŸ‘, â¤ï¸, ğŸ˜‚):");
        if (!emoji || !emoji.trim()) return;
        
        try {
            await callChatHandler('react', { message_id: messageId, emoji: emoji.trim() });
            alert(`å·²å°è¨Šæ¯ ${messageId} åŠ å…¥ ${emoji.trim()} åæ‡‰ã€‚`);
        } catch (error) {
            alert(`åæ‡‰å¤±æ•—: ${error.message}`);
        }
    }


    async function sendMessage() {
      if (isTyping) return;
      const msg = userInput.value.trim();
      if (!msg) return;

      userInput.value = "";
      sendBtn.disabled = true;
      isTyping = true;
      
      try {
        if (currentChatType === 'ai') {
          // --- AI èŠå¤© (å‘¼å« FayAI Smart Function) ---
          // å…ˆåœ¨ UI é¡¯ç¤ºç”¨æˆ¶è¨Šæ¯
          addBubble({ 
              id: Date.now(), 
              chat_id: 'fay_ai_chat', 
              user_id: currentUser.id, 
              content: msg, 
              profiles: { username: currentUser.profile.username } 
          });
          
          showTypingIndicator(); // é¡¯ç¤º AI æ­£åœ¨è¼¸å…¥
          await handleAiChat(msg); // å‘¼å« AI è™•ç†å™¨
          hideTypingIndicator(); 
          
        } else {
          // --- P2P / Group èŠå¤© (å‘¼å« Chat Handler Function) ---
          await callChatHandler('send', {
              chat_id: currentChatId,
              content: msg,
          });
          // Realtime æœƒè‡ªå‹•æ¥æ”¶ä¸¦é¡¯ç¤º
        }
      } catch (e) {
        console.error("âŒ è¨Šæ¯ç™¼é€éŒ¯èª¤:", e);
        alert(`è¨Šæ¯ç™¼é€å¤±æ•—: ${e.message}`);
      } finally {
        sendBtn.disabled = false;
        isTyping = false;
      }
    }
    
    // AI èŠå¤© (å‘¼å« FayAI Smart Function)
    async function handleAiChat(msg) {
        const { data } = await supabase.auth.getSession();
        const res = await fetch(FAY_AI_API_URL, {
            method: "POST",
            headers: { 
                "Content-Type": "application/json", 
                "Authorization": `Bearer ${data.session?.access_token}` 
            },
            body: JSON.stringify({ userId: currentUser.id, message: msg }),
        });
        const result = await res.json();
        const reply = result.reply || "AI éŒ¯èª¤ ğŸ’¬";
        addBubble({ 
            id: Date.now() + 1, 
            chat_id: 'fay_ai_chat', 
            user_id: 'fay_ai_bot', 
            content: reply, 
            profiles: { username: 'AI' } 
        });
    }

    // ===========================================
    // âœ… å¥½å‹èˆ‡è¨­å®š (éƒ¨åˆ† Edge Function é©…å‹•)
    // ===========================================
    
    async function handleAddFriend() {
      const friendUsername = friendUsernameInput.value.trim();
      if (!friendUsername) {
         alert("è«‹è¼¸å…¥å¥½å‹çš„ã€Œå¥½å‹ IDã€(Username):");
         return;
      }
      
      addFriendSubmitBtn.disabled = true;
      addFriendSubmitBtn.textContent = "å‚³é€ä¸­...";
      
      try {
        // å‘¼å« Edge Function è™•ç†æ–°å¢å¥½å‹ (ä¸¦å»ºç«‹èŠå¤©å®¤)
        const result = await callChatHandler('add_friend', { friend_username: friendUsername });
        
        alert("å·²æˆåŠŸæ–°å¢å¥½å‹ä¸¦å»ºç«‹èŠå¤©å®¤ï¼");
        friendUsernameInput.value = ""; 
        closeSettings(); 
        await loadChatList(); // é‡æ–°è¼‰å…¥èŠå¤©åˆ—è¡¨
      } catch (e) {
        alert(`æ–°å¢å¥½å‹å¤±æ•—: ${e.message}`);
        console.error("æ–°å¢å¥½å‹éŒ¯èª¤:", e);
      } finally {
        addFriendSubmitBtn.disabled = false;
        addFriendSubmitBtn.textContent = "é€å‡ºå¥½å‹é‚€è«‹";
      }
    }

    // ===========================================
    // âœ… è®€å–ã€Realtimeã€Profile (ä¿ç•™ Supabase Client RLS)
    // ===========================================
    
    // **æ³¨æ„:** é€™äº›æ˜¯ READ/STATUS ç›¸é—œæ“ä½œï¼Œä¿ç•™ Supabase Client å‘¼å«ä»¥åˆ©ç”¨ RLS
    
    async function loadChatHistory(chatId) {
        chatBox.innerHTML = ''; 
        
        const { data, error } = await supabase
            .from('messages')
            .select(`*, profiles ( username, avatar_url )`)
            .eq('chat_id', chatId)
            .order('created_at', { ascending: true })
            .limit(100);
            
        if (error) {
            console.error("è¼‰å…¥æ­·å²è¨Šæ¯å¤±æ•—:", error);
            return;
        }
        
        for (const message of data) {
            addBubble(message, false); 
        }
        scrollToBottom();
    }

    function subscribeToChat(newChatId) {
        if (realtimeChannel) {
            supabase.removeChannel(realtimeChannel);
        }

        realtimeChannel = supabase.channel(`chat_${newChatId}`);
        
        realtimeChannel
            .on(
                'postgres_changes',
                { event: 'INSERT', schema: 'public', table: 'messages', filter: `chat_id=eq.${newChatId}` },
                async (payload) => {
                    const newMessage = payload.new;
                    // æŠ“å–ç™¼é€è€…çš„ Profile 
                    let profile = newMessage.profiles;
                    if (!profile) {
                         const { data } = await supabase
                          .from('profiles')
                          .select('username')
                          .eq('id', newMessage.user_id)
                          .single();
                         profile = data;
                    }

                    addBubble({ ...newMessage, profiles: profile });
                    
                    // æ›´æ–°å´é‚Šæ¬„æœ€å¾Œä¸€å‰‡è¨Šæ¯
                    const lastMsgEl = document.getElementById(`last_msg_${newChatId}`);
                    if (lastMsgEl) lastMsgEl.textContent = newMessage.content.substring(0, 30);
                }
            )
            .on(
                'postgres_changes',
                { event: 'DELETE', schema: 'public', table: 'messages', filter: `chat_id=eq.${newChatId}` },
                (payload) => {
                    const deletedId = payload.old.id;
                    const msgElement = document.querySelector(`[data-message-id="${deletedId}"]`);
                    if (msgElement) {
                        msgElement.remove();
                    }
                }
            )
            .subscribe((status) => {
                if (status === 'SUBSCRIBED') {
                    console.log(`âœ… Realtime Channel ${newChatId} subscribed!`);
                }
            });
    }

    function switchChat(chatItem) {
        const newChatId = chatItem.dataset.chatId;
        const newChatName = chatItem.dataset.chatName;
        const newChatType = /** @type {ChatType} */ (chatItem.dataset.chatType);

        if (newChatId === currentChatId) return;

        document.querySelectorAll('.chat-item').forEach(item => item.classList.remove('active'));
        chatItem.classList.add('active');
        
        currentChatId = newChatId;
        currentChatType = newChatType;
        chatHeader.textContent = newChatName;
        chatBox.innerHTML = ''; 
        hideTypingIndicator(); 

        if (newChatType === 'ai') {
          if (realtimeChannel) { 
              supabase.removeChannel(realtimeChannel);
              realtimeChannel = null;
          }
          addBubble({ 
              id: Date.now(), 
              chat_id: newChatId,
              user_id: 'fay_ai_bot', 
              content: 'å—¨å—¨ï¼ğŸ’š æˆ‘æ˜¯ FayAI èªæ„å¼•æ“ï¼Œæˆ‘å€‘ä¾†èŠèŠ FayWooooo çš„æœ€æ–°å…§å®¹å§ï¼', 
              profiles: { username: 'AI' } 
          });
        } else {
          loadChatHistory(newChatId);
          subscribeToChat(newChatId);
        }
    }
    
    async function loadProfileSettings() {
      profileEmail.textContent = currentUser.email || "...";
      profileUsername.value = currentUser.profile?.username || "";
      profileUsername.placeholder = currentUser.profile?.username ? "" : "è«‹è¨­å®šæ‚¨çš„å¥½å‹ ID";
    }
    
    async function saveProfileSettings() {
      const newUsername = profileUsername.value.trim();
      if (!newUsername) {
        alert("å¥½å‹ ID (Username) ä¸å¯ç‚ºç©ºï¼");
        return;
      }
      
      saveProfileBtn.disabled = true;
      saveProfileBtn.textContent = "å„²å­˜ä¸­...";
      
      // ç›´æ¥ä½¿ç”¨ Supabase Client è™•ç† Profile æ›´æ–° (é Edge Function ç¯„åœ)
      const { data, error } = await supabase
        .from('profiles')
        .update({ username: newUsername })
        .eq('id', currentUser.id)
        .select()
        .single();
        
      if (error) {
        alert(`å„²å­˜å¤±æ•—: ${error.message}`);
      } else {
        alert("å€‹äººè³‡æ–™å·²å„²å­˜ï¼");
        currentUser.profile = data; 
        closeSettings();
      }
      saveProfileBtn.disabled = false;
      saveProfileBtn.textContent = "å„²å­˜è³‡æ–™";
    }

    async function loadFriendRequests() {
        if (!currentUser?.id) return;
        
        const { data, error } = await supabase
            .from('friends')
            .select(`
                id,
                user_id_1,
                profiles:user_id_1 (username)
            `)
            .eq('user_id_2', currentUser.id)
            .eq('status', 'pending');
            
        if (error) {
            console.error("è¼‰å…¥å¥½å‹è«‹æ±‚å¤±æ•—:", error);
            return;
        }

        // æ¸…ç©ºä¸¦é‡å»º
        friendRequestsSection.innerHTML = '';
        if (data && data.length > 0) {
            const title = document.createElement('div');
            title.className = 'request-title';
            title.textContent = `å¾…è™•ç†å¥½å‹è«‹æ±‚ (${data.length})`;
            friendRequestsSection.appendChild(title);
            
            data.forEach(/** @param {FriendRequest} request */ (request) => {
                const item = document.createElement('div');
                item.className = 'request-item';
                item.innerHTML = `
                    <div class="chat-avatar" style="background: var(--color-delete);"><i class="fa-solid fa-bell"></i></div>
                    <div class="chat-info">
                        <div class="chat-name">${request.profiles?.username || 'æœªçŸ¥ç”¨æˆ¶'}</div>
                        <div class="chat-last-message">è«‹æ±‚åŠ å…¥å¥½å‹</div>
                    </div>
                    <div class="request-actions">
                        <button data-id="${request.id}" class="accept-btn">æ¥å—</button>
                        <button data-id="${request.id}" class="reject-btn" style="background: #555; color: white;">æ‹’çµ•</button>
                    </div>
                `;
                friendRequestsSection.appendChild(item);
            });
            
            // ç¶å®šæ¥å—æŒ‰éˆ•äº‹ä»¶ (ä½¿ç”¨åŸæœ‰çš„ RPC é‚è¼¯)
            friendRequestsSection.querySelectorAll('.accept-btn').forEach(btn => {
                btn.onclick = (e) => acceptFriendRequest(e.target.dataset.id);
            });
            // ç¶å®šæ‹’çµ•æŒ‰éˆ•äº‹ä»¶ (ä½¿ç”¨åŸæœ‰çš„ Placeholder)
            friendRequestsSection.querySelectorAll('.reject-btn').forEach(btn => {
                btn.onclick = () => alert("TODO: æ‹’çµ•åŠŸèƒ½å°šæœªå¯¦ä½œï¼");
            });
        }
    }
    
    /**
     * @param {string} requestId
     */
    async function acceptFriendRequest(requestId) {
        // ä½¿ç”¨åŸæœ‰çš„ RPC é‚è¼¯ä¾†è™•ç†ç‹€æ…‹è®Šæ›´å’ŒèŠå¤©å®¤å»ºç«‹
        const { data, error } = await supabase.rpc('accept_friend_request', {
            request_id: requestId
        });
        
        if (error) {
            alert(`æ¥å—å¤±æ•—: ${error.message}`);
            console.error("æ¥å—è«‹æ±‚éŒ¯èª¤:", error);
            return;
        }
        
        const result = data;
        if (result.error) {
            alert(result.error);
        } else {
            alert("å·²æˆåŠŸæ¥å—å¥½å‹è«‹æ±‚ï¼Œä¸¦é–‹å•Ÿæ–°çš„èŠå¤©å®¤ï¼");
            // é‡æ–°è¼‰å…¥åˆ—è¡¨å’Œè«‹æ±‚
            await loadFriendRequests();
            await loadChatList();
        }
    }
    
    function openSettings() {
      loadProfileSettings(); 
      settingsModal.style.display = "flex";
    }
    
    function closeSettings() {
      settingsModal.style.display = "none";
    }

    async function loadChatList() {
        p2pChatList.innerHTML = ''; 
        
        // ä½¿ç”¨åŸæœ‰çš„ RPC é‚è¼¯ä¾†è¼‰å…¥åˆ—è¡¨
        const { data, error } = await supabase.rpc('get_chat_list');
        
        if (error) {
            console.error("è¼‰å…¥èŠå¤©åˆ—è¡¨å¤±æ•—:", error);
            return;
        }

        if (data) {
            for (const chat of data) {
                addChatItemToSidebar(chat.id, chat.name, chat.type, chat.last_message_content);
            }
        }
    }

    // ===========================================
    // âœ… App å•Ÿå‹•
    // ===========================================
    async function initializeApp() {
    // 1. æª¢æŸ¥ç™»å…¥ä¸¦å–å¾— Profile
    const { data: { user } } = await supabase.auth.getUser();
    if (!user) {
        alert("è«‹å…ˆç™»å…¥ï¼");
        window.location.href = 'index.html'; 
        return;
    }
    
    const { data: profile, error } = await supabase
        .from('profiles')
        .select('*')
        .eq('id', user.id)
        .single();

    if (error || !profile) {
        console.error("æŠ“å– Profile å¤±æ•—", error);
    }
    
    currentUser = user;
    currentUser.profile = profile; 
    
    // 2. è¼‰å…¥åˆ—è¡¨ & å¾…è™•ç†è«‹æ±‚
    await loadChatList();
    await loadFriendRequests();
        
        // æ¯ 15 ç§’æª¢æŸ¥ä¸€æ¬¡æ–°çš„å¥½å‹è«‹æ±‚
        friendRequestInterval = setInterval(loadFriendRequests, 15000); 
        
        // 3. ç¶å®šäº‹ä»¶
        sendBtn.onclick = sendMessage;
        userInput.addEventListener("keydown", (e) => {
            if (e.key === "Enter") {
                e.preventDefault();
                sendMessage();
            }
        });
        
        addFriendBtn.onclick = openSettings; 
        settingsBtn.onclick = openSettings; 
        modalCloseBtn.onclick = closeSettings;
        saveProfileBtn.onclick = saveProfileSettings;
        addFriendSubmitBtn.onclick = handleAddFriend; // å‘¼å« Edge Function
        
        // é»æ“Š Modal å¤–éƒ¨ç°è‰²å€åŸŸé—œé–‰
        window.onclick = (event) => {
          if (event.target == settingsModal) {
            closeSettings();
          }
        }
        
        // é»æ“ŠèŠå¤©å®¤é …ç›®åˆ‡æ›
        chatListSidebar.addEventListener('click', (e) => {
            const item = e.target.closest('.chat-item');
            if (item) switchChat(item);
        });
        
        // 4. é è¨­å•Ÿå‹• AI èŠå¤©å®¤
        const aiChat = document.querySelector('.chat-item[data-chat-type="ai"]');
        if (aiChat) switchChat(aiChat);
    }
    
// ç›£è½ Session ç‹€æ…‹è®ŠåŒ–ï¼Œåªæœ‰åœ¨ç¢ºèªç™»å…¥å¾Œæ‰å•Ÿå‹• App
supabase.auth.onAuthStateChange(async (event, session) => {
    // INITIAL_SESSION: ç¬¬ä¸€æ¬¡è¼‰å…¥é é¢æ™‚ç‹€æ…‹å·²ç¢ºèª
    // SIGNED_IN: å¾ç™»å…¥é è·³è½‰éä¾†æˆ–é‡æ–°æ•´ç† token
    if (event === 'INITIAL_SESSION' || event === 'SIGNED_IN') {
        if (!session) {
            // è™•ç†æ¥µç«¯æƒ…æ³ï¼Œå¦‚æœ INITIAL_SESSION ä½†æ²’æœ‰ session
            alert("è«‹å…ˆç™»å…¥ï¼");
            window.location.href = 'index.html'; 
            return;
        }
        
        const user = session.user;
        
        // é‡æ–°åŸ·è¡Œ Profile æŠ“å– (å› ç‚º session.user ä¸åŒ…å« custom profile data)
        const { data: profile, error } = await supabase
            .from('profiles')
            .select('*')
            .eq('id', user.id)
            .single();

        if (error || !profile) {
            console.error("æŠ“å– Profile å¤±æ•—", error);
            // é€™è£¡å¯ä»¥é¸æ“‡æ˜¯å¦å°å‘éŒ¯èª¤é é¢ï¼Œç‚ºäº†ä¸ä¸­æ–· Appï¼Œå…ˆç¹¼çºŒ
        }

        // å•Ÿå‹•æ‡‰ç”¨ç¨‹å¼æ ¸å¿ƒé‚è¼¯
        await initializeApp(user, profile); 
        
        // ç¢ºä¿åªå•Ÿå‹•ä¸€æ¬¡å¥½å‹è«‹æ±‚æª¢æŸ¥ Interval
        if (!friendRequestInterval) {
            friendRequestInterval = setInterval(loadFriendRequests, 15000); 
        }

    } else if (event === 'SIGNED_OUT') {
        // ç”¨æˆ¶ç™»å‡º
        if (friendRequestInterval) {
            clearInterval(friendRequestInterval);
        }
        window.location.href = 'index.html';
    }
});

    initializeApp();

  </script>
</body>
</html>
