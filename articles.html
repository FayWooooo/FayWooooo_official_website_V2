<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>FayWooooo å®˜æ–¹ç¶²ç«™ - æ–‡ç« å°ˆå€</title>
  <link rel="stylesheet" href="css/style.css">
  <meta name="description" content="FayWooooo å®˜æ–¹ç¶²ç«™ - æ–‡ç« å°ˆå€" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/js/all.min.js"></script>
  <style>
    /* è¼‰å…¥è½‰åœˆæ¨£å¼ */
    #loader { display: none; text-align: center; padding: 50px; }
    .spinner {
      width: 40px; height: 40px; border: 4px solid rgba(255, 0, 255, 0.2);
      border-top: 4px solid #ff00ff; border-radius: 50%;
      animation: spin 1s linear infinite; display: inline-block;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    /* æ–‡ç« ä½ˆå±€ */
    .article-container { max-width: 800px; margin: 20px auto 100px auto; padding: 20px; }
    .article-card { cursor: pointer; text-align: left; margin-bottom: 20px; transition: 0.3s; }
    .article-card:hover { transform: translateY(-5px); border-color: #ff00ff; }
    
    .locked-overlay {
      background: rgba(255, 255, 255, 0.05); padding: 20px; border-radius: 10px;
      border: 1px dashed #ff00ff; margin-top: 20px; text-align: center;
    }
    .back-btn { margin-bottom: 20px; display: inline-block; cursor: pointer; color: #ffff00; }

    /* ç®¡ç†å“¡æ–°å¢å€åŸŸ */
    #adminSection { 
      display: none; background: rgba(255, 255, 0, 0.05); 
      border: 1px solid #ffff00; padding: 20px; border-radius: 15px; margin-bottom: 40px; 
    }
    .admin-input { 
      width: 100%; background: rgba(0,0,0,0.5); border: 1px solid #444; 
      color: white; padding: 10px; margin-bottom: 10px; border-radius: 5px; 
    }
  </style>
</head>
<body>

  <header class="topbar">
    <div class="logo"><i class="fa-solid fa-book-open"></i> FayWooooo æ–‡ç« </div>
    <nav class="navbar">
        <a href="/home"><i class="fas fa-home"></i>é¦–é </a>
        <a href="/shop"><i class="fa-solid fa-gift"></i> å…Œæ›</a>
        <a href="/live"><i class="fas fa-video"></i> ç›´æ’­</a>
        <a href="/articles"><i class="fa-solid fa-book-open"></i>æ–‡ç« å°ˆå€</a>
    </nav>
  </header>

  <main class="article-container" style="background:none;">
  

    <div id="loader">
      <div class="spinner"></div>
      <p style="color: #ff00ff; margin-top: 10px;">å‚³é€ä¸­...</p>
    </div>
  
    <div id="listView">
      <h2 class="title" style="font-size: 2.5rem;">æœ€æ–°æ–‡ç« </h2>
      <div id="listContent"></div>
    </div>
  
    <div id="detailView" style="display: none;">
      <div class="back-btn" onclick="goHome()"><i class="fa-solid fa-arrow-left"></i> è¿”å›åˆ—è¡¨</div>
      <div class="card" id="articleDetail">
        <h1 id="artTitle" style="color: #ffff00; font-size: 1.8rem;"></h1>
        <hr style="border: 0.5px solid rgba(255,255,255,0.1);">
        <p id="artContent" style="white-space: pre-wrap; font-size: 1.1rem; text-align: left; line-height: 1.6;"></p>
        <div id="lockMessage" class="locked-overlay" style="display: none;">
          <p>ğŸ”’ å‰©é¤˜å…§å®¹åƒ…é™æœƒå“¡é–±è®€</p>
          <button class="btn" onclick="location.href='login.html'">ç«‹å³ç™»å…¥</button>
        </div>
      </div>
    </div>
  </main>

  <nav class="mobile-nav">
    <a href="/home"><i class="fas fa-home"></i>é¦–é </a>
    <a href="/shop"><i class="fa-solid fa-gift"></i> å…Œæ›</a>
    <a href="/live"><i class="fas fa-video"></i> ç›´æ’­</a>
    <a href="/articles"><i class="fa-solid fa-book-open"></i>æ–‡ç« å°ˆå€</a>
  </nav>

  <script type="module">
    import { supabase } from "./js/supabase-config.js";
    
    // è«‹ç¢ºèªæ­¤ URL èˆ‡ä½ çš„ Edge Function éƒ¨ç½²ç¶²å€ä¸€è‡´
    const API_URL = "https://wcqutexugvrgnyusnkpv.supabase.co/functions/v1/articles";
  
    const loader = document.getElementById("loader");
    const listView = document.getElementById("listView");
    const detailView = document.getElementById("detailView");
    const adminSection = document.getElementById("adminSection");
    const listContent = document.getElementById("listContent");
  
    // --- 1. æ ¸å¿ƒé‚è¼¯ï¼šæ§åˆ¶é¡¯ç¤ºç‹€æ…‹ ---
    function setLoading(isLoading) {
      loader.style.display = isLoading ? "block" : "none";
      if (isLoading) {
        listView.style.display = "none";
        detailView.style.display = "none";
      }
    }
  
    // --- 2. æ ¸å¿ƒé‚è¼¯ï¼šå°è£ API è«‹æ±‚ ---
    async function fetchData(action, body = {}) {
      setLoading(true);
      try {
        const { data: { session } } = await supabase.auth.getSession();
        const token = session?.access_token;
  
        const res = await fetch(API_URL, {
          method: "POST",
          headers: { 
            "Content-Type": "application/json", 
            "Authorization": token ? `Bearer ${token}` : "" 
          },
          body: JSON.stringify({ action, ...body })
        });
  
        // å¦‚æœ API å›å‚³ 401 æˆ–å…¶ä»–éŒ¯èª¤ï¼Œå›å‚³ç©ºé è¨­å€¼
        if (!res.ok) {
          const errText = await res.text();
          console.warn(`API è­¦å‘Š (${res.status}):`, errText);
          return { articles: [], success: false, fullAccess: false };
        }
  
        return await res.json();
      } catch (err) {
        console.error("ç¶²è·¯è«‹æ±‚å‡ºéŒ¯:", err);
        return { articles: [], success: false };
      } finally {
        setLoading(false);
      }
    }
  
    // --- 3. ç®¡ç†å“¡åŠŸèƒ½ ---
    async function checkAdmin() {
      try {
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) return;
        
        const { data: admin, error } = await supabase
          .from('admin_users')
          .select('email')
          .eq('email', user.email)
          .maybeSingle();
        
        if (admin && !error) adminSection.style.display = "block";
      } catch (e) {
        console.log("éç®¡ç†å“¡èº«åˆ†æˆ– admin_users è¡¨ä¸å­˜åœ¨");
      }
    }
  
window.publishArticle = async () => {
  const title = document.getElementById("newTitle").value.trim();
  const summary = document.getElementById("newSummary").value.trim();
  const content = document.getElementById("newContent").value.trim();

  if(!title || !content) return alert("è«‹å¡«å¯«æ¨™é¡Œèˆ‡å…§å®¹");

  setLoading(true);
  try {
    const { data: { session } } = await supabase.auth.getSession();
    const user = session?.user;
    const token = session?.access_token;

    // å‘¼å« admin Edge Function
    const res = await fetch("https://wcqutexugvrgnyusnkpv.supabase.co/functions/v1/admin?action=addArticle", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": `Bearer ${token}`
      },
      body: JSON.stringify({
        email: user.email, // ç®¡ç†å“¡è‡ªå·±çš„ Emailï¼Œç”¨æ–¼å¾Œç«¯ verifyAdmin
        title,
        summary,
        content
      })
    });

    const result = await res.json();
    if (result.success) {
      alert("âœ… æ–‡ç« ç™¼å¸ƒæˆåŠŸï¼");
      location.reload();
    } else {
      alert("âŒ ç™¼å¸ƒå¤±æ•—ï¼š" + (result.error || "æœªçŸ¥éŒ¯èª¤"));
    }
  } catch (err) {
    console.error(err);
    alert("âš ï¸ ç³»çµ±é€£ç·šå¤±æ•—");
  } finally {
    setLoading(false);
  }
};
  
    // --- 4. è·¯ç”±èˆ‡ç¶²å€è™•ç† ---
    function getArticleIdFromURL() {
      const path = window.location.pathname;
      // å‡è¨­è·¯å¾‘æ ¼å¼ç‚º /articles/123 æˆ– /articles.html/123
      const parts = path.split('/').filter(p => p); 
      const lastPart = parts[parts.length - 1];
      
      // å¦‚æœæœ€å¾Œä¸€æ®µä¸æ˜¯ articles ä¸”ä¸æ˜¯ articles.htmlï¼Œå‰‡è¦–ç‚º ID
      if (lastPart && !lastPart.includes('articles')) {
        return lastPart;
      }
      return null;
    }
  
    function updateURL(id = null) {
      const newPath = id ? `/articles/${id}` : `/articles`;
      window.history.pushState({ id }, "", newPath);
    }
  
    // --- 5. è¦–åœ–è¼‰å…¥é‚è¼¯ ---
    async function loadArticles() {
      const res = await fetchData("listArticles");
      listView.style.display = "block";
      
      if (!res.articles || res.articles.length === 0) {
        listContent.innerHTML = `<p style="color: #888; padding: 20px;">å°šç„¡æ–‡ç« å…§å®¹</p>`;
        return;
      }
  
      listContent.innerHTML = res.articles.map(art => `
        <div class="card article-card" onclick="goToArticle('${art.id}')">
          <h3 style="margin:0; color:#ffff00;">${art.title}</h3>
          <p style="font-size:0.9rem; color:#ccc; margin: 10px 0;">${art.summary || 'é»æ“Šé–±è®€æ›´å¤š...'}</p>
          <small style="color: #666;"><i class="fa-regular fa-calendar"></i> ${new Date(art.created_at).toLocaleDateString()}</small>
        </div>
      `).join('');
    }
  
    async function loadDetail(id) {
      const res = await fetchData("getArticle", { articleId: id });
      if (!res || !res.success) {
        alert(res?.error || "ç„¡æ³•è¼‰å…¥æ–‡ç« ");
        goHome();
        return;
      }
  
      detailView.style.display = "block";
      document.getElementById("artTitle").innerText = res.article.title;
      document.getElementById("artContent").innerText = res.article.content;
      
      // æ ¹æ“šå¾Œç«¯å›å‚³çš„ fullAccess æ±ºå®šæ˜¯å¦é¡¯ç¤ºã€Œç™»å…¥é–ã€
      document.getElementById("lockMessage").style.display = res.fullAccess ? "none" : "block";
    }
  
    // --- 6. å…¨åŸŸå°èˆªå‡½æ•¸ ---
    window.goToArticle = (id) => {
      updateURL(id);
      loadDetail(id);
    };
  
    window.goHome = () => {
      updateURL(null);
      loadArticles();
    };
  
    window.onpopstate = () => router();
  
    async function router() {
      const id = getArticleIdFromURL();
      if (id) {
        await loadDetail(id);
      } else {
        await loadArticles();
      }
    }
  
    // å•Ÿå‹•
    checkAdmin();
    router();
  </script>
</body>
</html>