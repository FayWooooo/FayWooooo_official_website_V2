<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>FayWooooo å®˜æ–¹ç¶²ç«™ - æ–‡ç« å°ˆå€</title>
  <meta name="description" content="FayWooooo å®˜æ–¹ç¶²ç«™çš„æ–‡ç« å°ˆå€ï¼Œæä¾›æœ€æ–°æ–‡ç« èˆ‡è³‡è¨Šï¼" />
  
  <base href="/" /> 
  <link rel="stylesheet" href="css/style.css" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/umd/supabase.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/js/all.min.js"></script>

  <style>
    .article-container {
      width: 90%;
      max-width: 800px;
      margin: 20px auto 100px auto;
      padding: 0 10px;
    }
    #artContent {
      white-space: pre-wrap; 
      font-size: 1.1rem; 
      text-align: left; 
      line-height: 1.8;
      color: #eee;
    }
    #artContent a {
      color: #ffff00;
      text-decoration: underline;
      font-weight: bold;
    }
    .back-btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      color: #ffff00;
      cursor: pointer;
      margin-bottom: 20px;
      font-weight: bold;
      transition: 0.3s;
    }
    .back-btn:hover { transform: translateX(-5px); }
    
    @media(max-width: 600px) {
      .title { font-size: 2rem !important; }
      #artTitle { font-size: 1.4rem !important; }
    }
  </style>
</head>
<body>

  <header class="topbar">
    <div class="logo"><i class="fa-solid fa-book-open"></i> FayWooooo æ–‡ç« </div>
    <nav class="navbar">
      <a href="index.html"><i class="fas fa-home"></i> é¦–é </a>
      <a href="shop.html"><i class="fa-solid fa-gift"></i> å…Œæ›</a>
      <a href="live.html"><i class="fas fa-video"></i> ç›´æ’­</a>
      <a href="articles.html"><i class="fa-solid fa-book-open"></i> æ–‡ç« å°ˆå€</a>
    </nav>
  </header>

  <main class="article-container" style="background:none;">
    
    <div id="loader" style="display:none;">
      <div class="spinner"></div>
      <p style="color: #ff00ff; margin-top: 15px; font-weight: bold;">è¼‰å…¥ä¸­...</p>
    </div>

    <div id="listView">
      <h1 class="title">æœ€æ–°æ–‡ç« </h1>
      <div id="listContent"></div>
    </div>

    <div id="detailView" style="display: none;">
      <div class="back-btn" onclick="goHome()">
        <i class="fa-solid fa-arrow-left"></i> è¿”å›åˆ—è¡¨
      </div>
      
      <article class="card">
        <h1 id="artTitle" style="color: #ffff00; text-align: left; margin-bottom: 10px;"></h1>
        <div style="font-size: 0.85rem; color: #888; margin-bottom: 20px;">
          <i class="fa-regular fa-calendar"></i> <span id="artDate"></span>
        </div>
        <hr style="border: 0; border-top: 1px solid rgba(255,255,255,0.1); margin-bottom: 25px;">
        
        <div id="artContent"></div>

        <div id="lockMessage" class="locked-overlay" style="display: none;">
          <p><i class="fa-solid fa-lock"></i> å‰©é¤˜ç²¾å½©å…§å®¹åƒ…é™æœƒå“¡é–±è®€</p>
          <button class="main-btn" onclick="location.href='login.html'" style="margin-top: 10px;">
            ç«‹å³ç™»å…¥
          </button>
        </div>
      </article>
    </div>
  </main>

  <nav class="mobile-nav">
    <a href="index.html"><i class="fas fa-home"></i><span>é¦–é </span></a>
    <a href="shop.html"><i class="fa-solid fa-gift"></i><span>å…Œæ›</span></a>
    <a href="live.html"><i class="fas fa-video"></i><span>ç›´æ’­</span></a>
    <a href="articles.html"><i class="fa-solid fa-book-open"></i><span>æ–‡ç« </span></a>
  </nav>

  <script type="module">
    import { supabase } from "./js/supabase-config.js";
    
    const API_URL = "https://wcqutexugvrgnyusnkpv.supabase.co/functions/v1/articles";
    const loader = document.getElementById("loader");
    const listView = document.getElementById("listView");
    const detailView = document.getElementById("detailView");
    const listContent = document.getElementById("listContent");

    function setLoading(isLoading) {
        loader.style.display = isLoading ? "block" : "none";
        if (isLoading) {
            listView.style.display = "none";
            detailView.style.display = "none";
        }
    }

    // --- æ ¸å¿ƒä¿®æ”¹ï¼šAPI è«‹æ±‚èˆ‡ 401 æ””æˆª ---
    async function fetchData(action, body = {}) {
        setLoading(true);
        try {
            const { data } = await supabase.auth.getSession();
            const token = data?.session?.access_token;

            const headers = { "Content-Type": "application/json" };
            if (token) headers["Authorization"] = `Bearer ${token}`;

            const res = await fetch(`${API_URL}?action=${action}`, {
                method: "POST",
                headers: headers,
                body: JSON.stringify(body)
            });

            // ğŸ¯ é€™è£¡è§¸ç™¼ï¼šåªè¦ API å›å‚³ 401 (Unauthorized)
            if (res.status === 401) {
                alert("è«‹å…ˆç™»å…¥å¾Œå†é–±è®€æ–‡ç« ï¼");
                window.location.href = "index.html"; 
                return null;
            }

            if (!res.ok) throw new Error(`ä¼ºæœå™¨å›æ‡‰éŒ¯èª¤: ${res.status}`);
            return await res.json();
        } catch (err) {
            console.error("API è«‹æ±‚ç™¼ç”ŸéŒ¯èª¤:", err.message);
            return { articles: [], success: false };
        } finally {
            setLoading(false);
        }
    }

    // --- è¼‰å…¥åˆ—è¡¨ ---
    async function loadArticles() {
        const res = await fetchData("listArticles");
        if (!res) return; // 401 å·²è·³è½‰

        listView.style.display = "block";
        if (!res.articles || res.articles.length === 0) {
            listContent.innerHTML = `<p style="color: #888; padding: 20px;">å°šç„¡æ–‡ç« å…§å®¹</p>`;
            return;
        }

        listContent.innerHTML = res.articles.map(art => `
            <div class="card article-card" onclick="goToArticle('${art.id}')" style="cursor:pointer">
                <h3 style="margin:0; color:#ffff00;">${art.title}</h3>
                <p style="font-size:0.95rem; color:#ccc; margin: 12px 0;">${art.summary || 'é»æ“Šé–±è®€å…¨æ–‡...'}</p>
                <div style="font-size: 0.8rem; color: #666;">
                    <i class="fa-regular fa-calendar"></i> ${new Date(art.created_at).toLocaleDateString()}
                </div>
            </div>
        `).join('');
    }

    // --- è¼‰å…¥è©³æƒ… ---
    async function loadDetail(id) {
        const res = await fetchData("getArticle", { articleId: id });
        if (!res) return; // 401 å·²è·³è½‰

        if (!res.success) {
            alert(res?.error || "ç„¡æ³•è¼‰å…¥æ–‡ç« ");
            goHome();
            return;
        }

        detailView.style.display = "block";
        document.getElementById("artTitle").innerText = res.article.title;
        document.getElementById("artDate").innerText = new Date(res.article.created_at).toLocaleDateString();
        document.getElementById("artContent").innerHTML = res.article.content; 
    }

    window.goToArticle = (id) => {
        window.history.pushState({ id }, "", `articles.html?id=${id}`);
        loadDetail(id);
    };

    window.goHome = () => {
        window.history.pushState({}, "", "articles.html");
        loadArticles();
    };

    window.onpopstate = () => router();

    async function router() {
        const urlParams = new URLSearchParams(window.location.search);
        const id = urlParams.get('id');
        if (id) {
            await loadDetail(id);
        } else {
            await loadArticles();
        }
    }

    router();
</script>
</body>
</html>
