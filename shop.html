<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FayWooooo å®˜æ–¹ç¶²ç«™</title>
  <link rel="stylesheet" href="css/style.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/js/all.min.js"></script>
</head>
<body>
  <header class="topbar">
    <div class="logo"><i class="fa-solid fa-gift"></i> Fayå¹£å…Œæ›ä¸­å¿ƒ</div>
    <nav class="navbar">
      <span id="coinDisplay"><i class="fa-solid fa-coins"></i> Fayå¹£ï¼šè¼‰å…¥ä¸­...</span>
      <a href="index.html"><i class="fa-solid fa-house"></i> é¦–é </a>
    </nav>
  </header>

  <main class="container2">
    <center><section class="card2">
      <h2><i class="fa-solid fa-box"></i> Fayå¯¶ç®±</h2>
      <p>æ¯æ¬¡é–‹å•Ÿéœ€ 100 Fayå¹£ï¼Œé–‹æ»¿ 10 ç®±å¯è§£é– Discord å°ˆå±¬èº«åˆ†çµ„ï¼</p>
      <button id="openBox" class="main-btn"><i class="fa-solid fa-box-open"></i> è³¼è²·å¯¶ç®±</button>
      <p id="result" style="margin-top:15px;color:gold;"></p>

      <div id="progressText" style="margin-top:8px;">è¼‰å…¥ä¸­...</div>
      <div id="progressBar" style="background:rgba(255,255,255,0.1);border-radius:10px;height:12px;margin-top:8px;max-width:400px;">
        <div id="progressFill" style="height:100%;width:0%;background:gold;border-radius:10px;"></div>
      </div>
    </section></center>

    <h2 style="margin-top:60px;"><i class="fa-solid fa-trophy"></i> çå‹µæ¸…å–®</h2>
    <div id="rewardList">è¼‰å…¥ä¸­...</div>
  </main>

  <footer>Â© 2025 FayWooooo</footer>

  <script type="module">
import { supabase } from "./js/supabase-config.js";

const API_URL = "https://wcqutexugvrgnyusnkpv.supabase.co/functions/v1/rewards";
const result = document.getElementById("result");
const progressText = document.getElementById("progressText");
const progressFill = document.getElementById("progressFill");
const rewardList = document.getElementById("rewardList");
const coinDisplay = document.getElementById("coinDisplay");

// âœ… å–å¾—ä½¿ç”¨è€… session
async function getUserSession() {
  const { data } = await supabase.auth.getSession();
  const session = data.session;
  if (!session) {
    alert("è«‹å…ˆç™»å…¥ï¼");
    throw new Error("No session");
  }
  return { email: session.user.email, token: session.access_token, id: session.user.id };
}

// âœ… è¼‰å…¥ Fay å¹£é¤˜é¡
async function loadFaycoins() {
  try {
    const { email } = await getUserSession();
    const { data } = await supabase
      .from("profiles")
      .select("faycoins")
      .eq("email", email)
      .maybeSingle();

    if (data && data.faycoins !== undefined) {
      coinDisplay.innerHTML = `<i class="fa-solid fa-coins"></i> Fayå¹£ï¼š${data.faycoins}`;
    } else {
      coinDisplay.textContent = "âš ï¸ ç„¡æ³•è¼‰å…¥ Fay å¹£";
    }
  } catch (err) {
    console.error("loadFaycoins éŒ¯èª¤:", err);
    coinDisplay.textContent = "âš ï¸ å°šæœªç™»å…¥";
  }
}

// âœ… å•Ÿç”¨å³æ™‚ç›£è½ Fay å¹£è®ŠåŒ–
async function watchFaycoins() {
  try {
    const { id } = await getUserSession();

    supabase
      .channel("realtime-faycoins")
      .on("postgres_changes", 
        { event: "UPDATE", schema: "public", table: "profiles", filter: `id=eq.${id}` },
        (payload) => {
          const newCoins = payload.new.faycoins;
          coinDisplay.innerHTML = `<i class="fa-solid fa-coins"></i> Fayå¹£ï¼š${newCoins}`;
        }
      )
      .subscribe();
  } catch (err) {
    console.error("å•Ÿç”¨å³æ™‚ç›£è½å¤±æ•—ï¼š", err);
  }
}

// âœ… é–‹ç®±
document.getElementById("openBox").onclick = async () => {
  try {
    const { email, token } = await getUserSession();
    result.innerHTML = `<i class="fa-solid fa-spinner fa-spin"></i> äº¤æ˜“è™•ç†ä¸­...`;

    const res = await fetch(API_URL, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": `Bearer ${token}`
      },
      body: JSON.stringify({ action: "openBox", email })
    });

    const data = await res.json();
    if (data.success) {
      result.innerHTML = `ğŸ‰ ç²å¾— <b>${data.reward}</b>`;
      if (data.special) result.innerHTML += "<br>ğŸŒŸ ç‰¹åˆ¥çå‹µå·²è§£é–ï¼";
      progressText.textContent = `å·²é–‹å•Ÿ ${data.progress}/10 ç®±`;
      progressFill.style.width = `${data.progress * 10}%`;
    } else {
      result.textContent = `âŒ ${data.error || "é–‹ç®±å¤±æ•—"}`;
    }
  } catch (err) {
    console.error("openBox éŒ¯èª¤:", err);
    result.textContent = "âš ï¸ è«‹å…ˆç™»å…¥å†å˜—è©¦é–‹ç®±ã€‚";
  }
};

// âœ… è¼‰å…¥çå‹µæ¸…å–®
async function loadRewards() {
  try {
    const { email, token } = await getUserSession();
    const res = await fetch(API_URL, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": `Bearer ${token}`
      },
      body: JSON.stringify({ action: "listRewards", email })
    });

    const data = await res.json();
    if (data.success) {
      rewardList.innerHTML = data.rewards.map(r => `
        <div class="reward-card">
          <div class="reward-info">
            <div class="reward-title">${r.title}</div>
            <div class="reward-desc">${r.description || ""}</div>
          </div>
          <div class="reward-action">
            <div class="reward-price"><i class="fa-solid fa-coins"></i> ${r.price}</div>
            <button class="buy-btn" data-id="${r.id}" data-title="${r.title}">
              è³¼è²·
            </button>
          </div>
        </div>
      `).join("");

      document.querySelectorAll(".buy-btn").forEach(btn => {
        btn.addEventListener("click", async (e) => {
          const id = e.target.dataset.id;
          const title = e.target.dataset.title;
          if (!confirm(`ç¢ºèªè³¼è²·ã€Œ${title}ã€å—ï¼Ÿ`)) return;

          const { email, token } = await getUserSession();
          const res = await fetch(API_URL, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "Authorization": `Bearer ${token}`
            },
            body: JSON.stringify({ action: "buyReward", email, rewardId: id })
          });

          const result = await res.json();
          alert(result.success ? `âœ… ${result.message}` : `âŒ ${result.error}`);
        });
      });
    } else {
      rewardList.textContent = "âŒ ç„¡æ³•è¼‰å…¥çå‹µã€‚";
    }
  } catch (err) {
    console.error("loadRewards éŒ¯èª¤:", err);
    rewardList.textContent = "âš ï¸ è«‹ç™»å…¥ä»¥è¼‰å…¥çå‹µã€‚";
  }
}

// âœ… è¼‰å…¥é–‹ç®±é€²åº¦
async function loadProgress() {
  try {
    const { email, token } = await getUserSession();
    const res = await fetch(API_URL, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": `Bearer ${token}`
      },
      body: JSON.stringify({ action: "progress", email })
    });
    const data = await res.json();
    if (data.success) {
      progressText.textContent = `å·²é–‹å•Ÿ ${data.progress}/10 ç®±`;
      progressFill.style.width = `${data.progress * 10}%`;
    } else {
      progressText.textContent = "âš ï¸ ç„¡æ³•å–å¾—é€²åº¦";
    }
  } catch (err) {
    console.error("loadProgress éŒ¯èª¤:", err);
  }
}

// ğŸš€ å•Ÿå‹•
await loadFaycoins();
await loadRewards();
await loadProgress();
await watchFaycoins(); // âœ… å³æ™‚ç›£è½ Fay å¹£è®ŠåŒ–
</script>
</body>
</html>
